# æœ‹å‹åœˆAIï¼šåˆå¹¶ä¸ºå•æ¬¡APIè°ƒç”¨ä¼˜åŒ–æ–¹æ¡ˆ

## å½“å‰é—®é¢˜

å‘å¸ƒå¸¦å›¾ç‰‡çš„æœ‹å‹åœˆæ—¶ï¼Œéœ€è¦**2æ¬¡APIè°ƒç”¨**ï¼š
1. **å›¾ç‰‡è¯†åˆ«**ï¼šè¯†åˆ«å›¾ç‰‡å†…å®¹ â†’ "ä¸€ä¸ªç²‰è‰²çš„åƒç´ é£éŸ³ä¹æ’­æ”¾å™¨"
2. **åœºæ™¯ç¼–æ’**ï¼šåŸºäºæè¿°ç¼–æ’äº’åŠ¨ â†’ æ–¹äº¦æ¥·245ç§’åè¯„è®º

**æˆæœ¬**ï¼šåŒå€Tokenæ¶ˆè€— + æ›´é•¿å“åº”æ—¶é—´

## ä¼˜åŒ–æ–¹æ¡ˆï¼šåˆå¹¶ä¸ºä¸€æ¬¡è°ƒç”¨

### æ ¸å¿ƒæ€è·¯

è®©AIåœ¨ä¸€æ¬¡è°ƒç”¨ä¸­åŒæ—¶å®Œæˆï¼š
1. ç†è§£å›¾ç‰‡å†…å®¹
2. ç¼–æ’å„è§’è‰²çš„äº’åŠ¨

### å®ç°æ–¹å¼

```typescript
const messages = [
  {
    role: 'system',
    content: SYSTEM_PROMPT + `
      
âš ï¸ ç‰¹åˆ«è¯´æ˜ï¼š
å¦‚æœæœ‹å‹åœˆåŒ…å«å›¾ç‰‡ï¼Œä½ éœ€è¦å…ˆç†è§£å›¾ç‰‡å†…å®¹ï¼Œç„¶ååŸºäºå›¾ç‰‡å†…å®¹ç¼–æ’äº’åŠ¨ã€‚
è¯·ç›´æ¥ç¼–æ’åœºæ™¯ï¼Œä¸éœ€è¦å•ç‹¬è¾“å‡ºå›¾ç‰‡æè¿°ã€‚
    `
  },
  {
    role: 'user',
    content: [
      {
        type: 'text',
        text: buildDirectorPrompt(moment, charactersInfo, momentsHistory, aiMemory, publisherPersonality)
      },
      // ğŸ”¥ å¦‚æœæœ‰å›¾ç‰‡ï¼Œç›´æ¥é™„åŠ ï¼ˆå‹ç¼©åï¼‰
      ...moment.images.map(img => ({
        type: 'image_url',
        image_url: { url: compressedImageUrl }
      }))
    ]
  }
]
```

### ä¼˜åŠ¿

âœ… **å‡å°‘50% Tokenæ¶ˆè€—**ï¼šåªè°ƒç”¨ä¸€æ¬¡API  
âœ… **æ›´å¿«å“åº”**ï¼šä¸éœ€è¦ç­‰å¾…ä¸¤æ¬¡APIå¾€è¿”  
âœ… **ç®€åŒ–é€»è¾‘**ï¼šæ— éœ€ç»´æŠ¤å›¾ç‰‡ç¼“å­˜ç³»ç»Ÿ  
âœ… **æ›´è‡ªç„¶**ï¼šAIåŒæ—¶çœ‹åˆ°å›¾ç‰‡å’Œä¸Šä¸‹æ–‡

### æ½œåœ¨é—®é¢˜

âš ï¸ **è¯·æ±‚ä½“è¿‡å¤§é£é™©**
- åœºæ™¯ç¼–æ’çš„Promptå·²ç»å¾ˆé•¿ï¼ˆè§’è‰²äººè®¾+èŠå¤©è®°å½•+å†å²ï¼‰
- åŠ ä¸Šå›¾ç‰‡base64å¯èƒ½è¶…å‡ºé™åˆ¶

### è§£å†³æ–¹æ¡ˆ

#### æ–¹æ¡ˆ1ï¼šæ™ºèƒ½é™çº§
```typescript
// å°è¯•ä¸€æ¬¡è°ƒç”¨
try {
  result = await callAPIWithImages(prompt, images)
} catch (error) {
  if (error.status === 413 || error.status === 503) {
    // è¯·æ±‚ä½“è¿‡å¤§ï¼Œé™çº§ä¸ºä¸¤æ¬¡è°ƒç”¨
    console.log('âš ï¸ è¯·æ±‚ä½“è¿‡å¤§ï¼Œä½¿ç”¨ä¸¤æ­¥è¯†å›¾æ–¹æ¡ˆ')
    imageDesc = await identifyImages(images)
    result = await arrangeScene(prompt + imageDesc)
  }
}
```

#### æ–¹æ¡ˆ2ï¼šç²¾ç®€Prompt
- åªä¿ç•™æœ€è¿‘10æ¡èŠå¤©è®°å½•ï¼ˆè€Œä¸æ˜¯30æ¡ï¼‰
- å‹ç¼©è§’è‰²äººè®¾ï¼ˆæå–å…³é”®ä¿¡æ¯ï¼‰
- æœ‹å‹åœˆå†å²åªä¿ç•™5æ¡ï¼ˆè€Œä¸æ˜¯10æ¡ï¼‰

#### æ–¹æ¡ˆ3ï¼šæ ¹æ®å›¾ç‰‡æ•°é‡é€‰æ‹©ç­–ç•¥
```typescript
if (images.length === 0) {
  // æ— å›¾ç‰‡ï¼šç›´æ¥ç¼–æ’
  result = await arrangeScene(prompt)
} else if (images.length === 1 && imageSize < 100KB) {
  // å•å¼ å°å›¾ï¼šä¸€æ¬¡è°ƒç”¨
  result = await arrangeSceneWithImage(prompt, image)
} else {
  // å¤šå¼ æˆ–å¤§å›¾ï¼šä¸¤æ¬¡è°ƒç”¨
  imageDesc = await identifyImages(images)
  result = await arrangeScene(prompt + imageDesc)
}
```

## æ¨èæ–¹æ¡ˆ

**æ–¹æ¡ˆ3ï¼ˆåŠ¨æ€é€‰æ‹©ï¼‰**æœ€ç¨³å¦¥ï¼š
- å¸¸è§æƒ…å†µï¼ˆå•å¼ å›¾ï¼‰ï¼šä¸€æ¬¡è°ƒç”¨ âœ¨
- æç«¯æƒ…å†µï¼ˆå¤šå›¾/å¤§å›¾ï¼‰ï¼šä¸¤æ¬¡è°ƒç”¨ä¿è¯ç¨³å®š
- è‡ªåŠ¨é€‚é…ï¼Œæ— éœ€ç”¨æˆ·å¹²é¢„

## å®æ–½æ­¥éª¤

1. âœ… ä¿ç•™ç°æœ‰ä¸¤æ­¥æ–¹æ¡ˆä½œä¸ºfallback
2. âœ… æ–°å¢å•æ­¥æ–¹æ¡ˆç”¨äºç®€å•åœºæ™¯
3. âœ… æ ¹æ®å›¾ç‰‡æ•°é‡å’Œå¤§å°æ™ºèƒ½é€‰æ‹©
4. âœ… æ·»åŠ é™çº§æœºåˆ¶å¤„ç†è¯·æ±‚è¿‡å¤§é”™è¯¯

## é¢„æœŸæ•ˆæœ

- **ç®€å•åœºæ™¯**ï¼ˆ1å¼ å°å›¾ï¼‰ï¼šèŠ‚çœ50% Token + æ›´å¿«å“åº”
- **å¤æ‚åœºæ™¯**ï¼ˆå¤šå¼ å›¾ï¼‰ï¼šä¿æŒç¨³å®šï¼Œä¸ä¼šå‡ºé”™
- **å¹³å‡ä¼˜åŒ–**ï¼šçº¦å‡å°‘30-40% APIè°ƒç”¨æˆæœ¬

## æ˜¯å¦å€¼å¾—ä¼˜åŒ–ï¼Ÿ

| å› ç´  | è¯„ä¼° |
|------|------|
| èŠ‚çœæˆæœ¬ | âœ… æ˜¾è‘—ï¼ˆæ¯æ¬¡æœ‹å‹åœˆäº’åŠ¨èŠ‚çœ1æ¬¡APIè°ƒç”¨ï¼‰|
| æå‡æ€§èƒ½ | âœ… ä¸­ç­‰ï¼ˆå‡å°‘ç½‘ç»œå¾€è¿”æ—¶é—´ï¼‰|
| ä»£ç å¤æ‚åº¦ | âš ï¸ å¢åŠ ï¼ˆéœ€è¦æ™ºèƒ½é€‰æ‹©å’Œé™çº§é€»è¾‘ï¼‰|
| ç¨³å®šæ€§é£é™© | âš ï¸ æœ‰ï¼ˆéœ€å……åˆ†æµ‹è¯•å¤§Prompt+å›¾ç‰‡åœºæ™¯ï¼‰|

**å»ºè®®**ï¼š
- å¦‚æœAPIæˆæœ¬æ˜¯ä¸»è¦è€ƒè™‘ â†’ **å€¼å¾—ä¼˜åŒ–**
- å¦‚æœç¨³å®šæ€§ä¼˜å…ˆ â†’ **ä¿æŒç°çŠ¶**
- æŠ˜ä¸­æ–¹æ¡ˆ â†’ **å…ˆå®æ–½ç®€å•çš„æ–¹æ¡ˆ3ï¼Œè§‚å¯Ÿæ•ˆæœ**
