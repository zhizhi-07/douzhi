# 世界书功能使用说明

## 功能概述

世界书（Lorebook）系统已成功集成到 Douzhi 项目中，支持：

✅ **创建和管理世界书**：完整的 CRUD 功能  
✅ **SillyTavern 兼容**：支持导入 SillyTavern 格式的世界书  
✅ **Character Card 集成**：导入角色卡时自动提取并保存世界书  
✅ **关键词触发**：基于关键词智能注入上下文  
✅ **优先级管理**：控制条目注入顺序  
✅ **Token 预算**：避免超出模型上下文限制  
✅ **角色绑定**：支持绑定到特定角色或设为全局  
✅ **条目启用/禁用**：快速开关条目生效状态  

---

## 如何使用

### 1. 访问世界书

在桌面或 Dock 中点击「世界书」应用图标，或访问：
```
http://localhost:3000/world-book
```

### 2. 创建世界书

1. 点击右上角「+」按钮
2. 填写世界书名称和描述
3. 设置扫描深度和 Token 预算
4. 添加条目：
   - **条目名称**：标识条目用途
   - **触发关键词**：输入关键词并回车添加
   - **内容**：要注入到 AI 上下文的文本
   - **优先级**：0-999，数值越大越优先
   - **插入位置**：顶部/角色前/角色后/底部
   - **高级选项**：启用、始终注入、大小写敏感等

### 3. 导入世界书

#### 方式一：直接导入 JSON 文件

1. 在世界书列表页点击「导入世界书」
2. 选择 JSON 文件（支持本系统格式和 SillyTavern 格式）
3. 自动创建新世界书

#### 方式二：从 Character Card 导入

1. 在创建角色页面，点击「上传」按钮
2. 选择包含世界书的 Character Card PNG 文件
3. 系统会自动：
   - 导入角色信息
   - 提取并保存世界书
   - 关联世界书到该角色

**提示**：导入成功后会显示包含的世界书条目数量

### 4. 编辑世界书

1. 在世界书列表中点击任意世界书卡片
2. 编辑基本信息、全局设置或条目
3. 点击右上角保存按钮

### 5. 导出世界书

1. 点击世界书卡片右侧的「⋮」按钮
2. 选择「导出」
3. 保存为 JSON 文件

---

## 文件结构

```
G:\douzhi\src\
├── utils\
│   └── lorebookSystem.ts          # 世界书核心系统
├── pages\
│   ├── WorldBook.tsx              # 世界书管理页面
│   ├── EditWorldBook.tsx          # 世界书编辑页面
│   └── CreateCharacter.tsx        # 已集成世界书导入
├── components\
│   └── Icons.tsx                  # 添加了世界书相关图标
└── config\
    └── apps.ts                    # 桌面应用配置
```

---

## 技术特性

### SillyTavern 格式兼容

自动识别和转换以下字段：

| SillyTavern | 本系统 | 说明 |
|------------|--------|------|
| keys | 关键词 | 触发关键词列表 |
| content | 内容 | 注入的文本内容 |
| priority | 优先级 | 0-999 |
| position (0/1/2/3) | 位置 | after_char/before_char/top/bottom |
| enabled/disable | 启用 | 条目开关 |
| constant | 始终注入 | 无需关键词触发 |
| case_sensitive | 大小写敏感 | 匹配选项 |

### 位置转换

```
SillyTavern 0 → 本系统 "角色后" (after_char)
SillyTavern 1 → 本系统 "角色前" (before_char)
SillyTavern 2 → 本系统 "顶部" (top)
SillyTavern 3 → 本系统 "底部" (bottom)
```

### 数据存储

- 使用 localStorage 存储
- 键名：`lorebooks`
- 支持增删改查操作
- 自动生成唯一 ID

---

## Character Card 导入增强

当从 PNG 导入 Character Card 时：

1. ✅ 自动检测 `character_book` 字段
2. ✅ 转换为本系统格式
3. ✅ 创建新世界书并关联到角色
4. ✅ 在导入提示中显示世界书条目数

**代码位置**：`CreateCharacter.tsx` 的 `handleSubmit` 函数

---

## 示例：修仙世界设定

### 世界书结构

```
名称：修仙世界
描述：完整的修仙世界观设定
扫描深度：10
Token 预算：2000
```

### 示例条目

**条目 1：境界设定**
```
名称：境界设定
关键词：境界, 修为, 实力
内容：修炼境界分为：炼气、筑基、金丹、元婴、化神、合体、渡劫、大乘
优先级：800
位置：角色前
```

**条目 2：主角信息**
```
名称：李明
关键词：李明, 主角
内容：李明，25岁，穿越者。拥有系统辅助，目前炼气三层。
优先级：900
位置：角色前
始终注入：是
```

---

## 常见问题

### Q: 导入失败怎么办？
A: 检查 JSON 文件格式是否正确，确保是从 SillyTavern 正确导出的文件。

### Q: 如何让世界书对所有角色生效？
A: 目前支持角色专属世界书，全局世界书功能待实现。

### Q: Character Card 中的世界书会覆盖现有的吗？
A: 不会，导入会创建新的世界书，不影响现有数据。

### Q: 如何删除世界书？
A: 在世界书列表中点击「⋮」菜单，选择「删除」。

---

## 下一步计划

可考虑的增强功能：

- [ ] 实现世界书内容注入到聊天 API
- [ ] 支持全局世界书（对所有角色生效）
- [ ] 世界书预览功能
- [ ] 批量导入/导出
- [ ] 正则表达式关键词匹配
- [ ] 条目分组和分类
- [ ] 搜索和过滤条目

---

## 技术支持

如有问题，请查看：
- `lorebookSystem.ts` - 核心逻辑
- `WorldBook.tsx` - 管理界面
- `EditWorldBook.tsx` - 编辑界面
- `characterCardParser.ts` - Character Card 解析

**当前状态**：✅ 所有核心功能已实现并集成到聊天系统

## 📊 Token 统计功能

已创建完整的 Token 统计工具和显示组件：
- ✅ `src/utils/tokenCounter.ts` - Token 估算和统计工具
- ✅ `src/pages/ChatDetail/components/TokenStatsDisplay.tsx` - 可视化显示组件
- 📄 详细实现指南见：`Token统计功能实现指南.md`

Token 统计功能可显示：
- 系统提示词 Token
- 角色信息 Token
- 世界书 Token
- 记忆系统 Token
- 历史消息 Token
- 响应时间
- 实际消费 Token
- 上下文使用率进度条
