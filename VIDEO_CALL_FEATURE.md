# 📹 视频通话功能说明

## ✅ 已完成的功能

### 1. 视频通话界面
- ✅ 全屏视频界面（对方大窗口 + 自己小窗口）
- ✅ 顶部信息栏（显示通话时长、角色名称）
- ✅ 底部控制按钮（静音、挂断、免提）
- ✅ 实时对话区域（支持文字聊天）
- ✅ 最小化悬浮窗
- ✅ AI打字状态显示

### 2. 通话功能
- ✅ 点击聊天页面右上角视频按钮发起通话
- ✅ 实时消息发送（用户/AI/旁白）
- ✅ AI自动回复（带表情和画面描述）
- ✅ 通话时长计时
- ✅ 挂断后自动保存通话记录

### 3. AI画面感描述
- ✅ AI会用`[画面:...]`描述表情和动作
- ✅ 旁白消息居中斜体显示
- ✅ 支持聊天上下文（AI知道之前的对话）

### 4. 通话记录
- ✅ 挂断后在聊天列表显示通话记录
- ✅ 显示通话时长
- ✅ 保存所有对话内容（可供AI查看）

---

## 🎮 使用方法

### 发起视频通话
1. 进入聊天页面
2. 点击右上角 **📹 视频图标**
3. 视频通话界面打开

### 通话中操作
- **发送消息**：输入框输入文字 → 点击发送
- **AI回复**：输入框为空 → 点击蓝色按钮
- **静音**：点击麦克风按钮
- **免提**：点击扬声器按钮
- **最小化**：点击左上角 `-` 按钮
- **挂断**：点击红色挂断按钮

### AI的表现
AI会：
- 描述自己的表情：`[画面:微笑着挥手]`
- 描述自己的动作：`[画面:撩了撩头发]`
- 描述情绪变化：`[画面:眼睛一亮，兴奋地往前凑]`
- 正常对话：`嘿！终于接通啦！`

---

## 📊 技术实现

### 文件结构
```
src/
├── components/
│   └── VideoCallScreen.tsx          # 视频通话UI组件
├── pages/ChatDetail/hooks/
│   └── useVideoCall.ts              # 视频通话逻辑Hook
├── utils/
│   └── chatApi.ts                   # 添加 buildVideoCallPrompt()
└── types/
    └── chat.ts                      # 添加 videoCallRecord 类型
```

### 核心代码

#### 1. 视频通话Hook
```typescript
export const useVideoCall = (
  character: Character | null,
  chatMessages: Message[],
  setMessages: (fn: (prev: Message[]) => Message[]) => void
) => {
  const [isCallActive, setIsCallActive] = useState(false)
  const [callMessages, setCallMessages] = useState<CallMessage[]>([])
  
  // 开始通话
  const startCall = () => { ... }
  
  // 结束通话（保存记录）
  const endCall = () => { ... }
  
  // 请求AI回复（解析画面描述）
  const requestAIReply = async () => { ... }
}
```

#### 2. AI提示词
```
你是 ${角色名}，正在和用户进行视频通话。

你需要：
1. 描述你的表情和动作
   - 使用 [画面:描述] 来表现视觉信息
   - 例如：[画面:微笑着挥手打招呼]
   
2. 回应对方的表情
3. 营造画面感
```

#### 3. 消息类型
```typescript
interface CallMessage {
  id: number
  type: 'user' | 'ai' | 'narrator'  // narrator = 画面描述
  content: string
  time: string
}
```

---

## 🎯 示例对话

### 用户发起通话
```
[系统] 视频通话已接通...
```

### AI响应（自动生成）
```
[画面:看到对方出现在屏幕上，开心地笑了]
嘿！终于接通啦！
[画面:撩了撩头发]
你今天看起来精神不错呀~
```

### 用户对话
```
用户: 今天心情不太好...
```

### AI回应
```
[画面:表情变得关切，身体往前凑了凑]
怎么啦？发生什么事了吗？
[画面:温柔地看着对方]
跟我说说？
```

---

## 🔧 配置要求

### API要求
- 需要配置可用的AI API（OpenAI/Gemini/其他）
- 模型需要支持多行输出
- 建议使用 temperature: 0.7

### 浏览器要求
- 现代浏览器（Chrome 90+, Safari 14+, Firefox 88+）
- 支持ES6+特性

---

## 📝 通话记录格式

挂断后在聊天列表显示：
```
┌─────────────────────┐
│ 📹 视频通话 2分30秒 │
└─────────────────────┘
```

点击可查看通话详情（包含所有对话和画面描述）

---

## 🎨 UI特点

### 视频通话界面
- 深色背景（黑色渐变）
- 半透明对话框（毛玻璃效果）
- 圆角设计（iOS风格）
- 平滑动画过渡

### 控制按钮
- 静音：灰色 → 红色（激活）
- 挂断：红色圆形大按钮
- 免提：灰色 → 绿色（激活）

### 消息气泡
- 用户消息：绿色气泡（右侧）
- AI消息：白色气泡（左侧）
- 旁白消息：居中斜体灰色

---

## 🚀 下一步计划

### 可扩展功能
- [ ] 录制通话
- [ ] 屏幕截图
- [ ] 表情包发送
- [ ] 虚拟背景
- [ ] AI主动发起通话
- [ ] 群组视频通话

---

## 📞 测试建议

1. **测试发起通话**
   - 点击视频按钮
   - 检查界面是否正常显示

2. **测试AI回复**
   - 点击蓝色按钮
   - 检查AI是否描述表情

3. **测试通话记录**
   - 挂断通话
   - 检查聊天列表是否显示记录

4. **测试最小化**
   - 点击最小化按钮
   - 检查悬浮窗是否显示

---

## 🎉 完成！

视频通话功能已全部实现，可以开始测试了！

刷新页面 → 进入聊天 → 点击右上角视频图标 → 开始通话！
