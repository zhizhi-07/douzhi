# 记忆系统 - 时间约定记录优化

## 问题描述

用户反馈：时间线中记录了"用户表示要等到过年才回来"，但记忆提取功能却没有记录这个重要的时间约定。

**时间线记录**：
```
"11月21日上午，方亦楷以玩笑开场，追问用户何时回来。用户表示要等到过年，方亦楷接受了这个约定..."
```

**记忆提取结果**：
- ❌ 没有记录"过年回来"这个时间约定
- ❌ 遗漏了重要的见面计划节点

## 根本原因

记忆提取的提示词对"event"（事件）类型的描述不够明确，缺少对时间约定的强调和具体示例，导致AI模型在提取记忆时容易忽略这类信息。

## 优化方案

### 修改文件：`src/utils/memorySystem.ts`

#### 1. 强化"客观信息"部分（第171行）

**添加内容**：
```
- **时间约定和计划**（什么时候见面、什么时候回来、重要节日、截止日期等）——这类信息很重要，一定要记录
```

#### 2. 优化记忆类型定义（第218-220行）

**修改前**：
```
* **event**: 重要经历、计划、互动事件
   * 例如: "用户下周三要面试", "AI初中送了一个娃娃给用户"
```

**修改后**：
```
* **event**: 重要经历、计划、互动事件、时间约定
   * 例如: "用户下周三要面试", "AI初中送了一个娃娃给用户", 
           "用户和AI约定周末去看电影", "用户要等到过年才回来", 
           "AI下个月要出差一周"
   * ⚠️ 特别注意：时间约定、见面计划、重要节点（过年/生日/节假日等）都要记录
```

#### 3. 明确重要度评分（第227-228行）

**添加说明**：
```
* **7-10**: 长期有效的重要信息（职业、住址、作息、核心喜好、重要计划、时间约定）
  * ⚠️ 时间约定和见面计划通常是7-9分，例如"过年回来"、"下周见面"、"生日约定"等
```

#### 4. 添加时间约定示例（第312-327行）

**新增示例5**：
```json
**示例5：记录时间约定（重要！）**
用户："我要等到过年才回来"
AI："好，那我等你过年回来"
{
  "title": "过年回来约定",
  "tags": ["时间约定", "见面计划", "重要节点"],
  "memories": [
    {
      "type": "event",
      "content": "用户要等到过年才能回来，AI答应等到那时候",
      "importance": 8,
      "tags": ["约定", "时间", "过年"]
    }
  ],
  "summary": "用户和AI约定过年见面"
}
```

#### 5. 补充"好的记忆"示例（第203行）

**添加**：
```
- "用户要等到过年才回来"（时间约定）
```

## 优化效果

### 优化前
- ❌ 容易漏记时间约定
- ❌ 没有明确的示例指导
- ❌ 重要度评分不清晰

### 优化后
- ✅ 明确强调时间约定的重要性（3处）
- ✅ 提供具体的"过年回来"示例
- ✅ 重要度评分说明清晰（7-9分）
- ✅ 在多个位置反复强化概念

## 覆盖的时间约定类型

记忆系统现在会重点记录：
1. **见面约定**："过年回来"、"下周见面"、"周末约会"
2. **重要节点**："生日"、"纪念日"、"节假日"
3. **截止日期**："下周三面试"、"月底交稿"
4. **时间计划**："下个月出差"、"明年去旅游"
5. **等待期限**："等三天"、"一个月后回复"

## 测试建议

使用以下对话测试记忆提取：

**测试1：长期约定**
```
用户："我要到春节才回来"
AI："好，那我等你春节回来"
```
预期记录：✅ event类型，重要度8-9分

**测试2：短期约定**
```
用户："下周三我们见面吧"
AI："好的，下周三见"
```
预期记录：✅ event类型，重要度7-8分

**测试3：重要节点**
```
用户："我生日是12月25日"
AI："记住了！"
```
预期记录：✅ fact类型，重要度8-9分

## 提示词优化总结

本次优化在6个位置强化了时间约定的记录：
1. ✅ 客观信息说明（第171行）
2. ✅ 好的记忆示例（第203行）
3. ✅ event类型定义（第218-220行）
4. ✅ 重要度评估说明（第227-228行）
5. ✅ 新增专门示例（第312-327行）
6. ✅ 多次使用⚠️标记提醒

通过多位置、多角度的强化，大幅提升AI模型对时间约定信息的敏感度和记录率。
