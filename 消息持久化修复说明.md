# 消息持久化修复说明

## 问题描述
转账、语音、位置、照片、撤回等功能退出窗口后消息消失，数据不保存。

## 根本原因
这些功能只更新了React状态（`setMessages`），但**没有调用`addMessage`或`saveMessages`保存到IndexedDB**，导致页面刷新或退出窗口后消息丢失。

## 修复内容

### 1. **转账消息** (`useTransfer.ts`)
- ✅ 发送转账时调用`saveMessageToStorage`保存
- ✅ 接收/退还转账时调用`saveMessages`保存整个消息列表
- ✅ 添加`chatId`参数

### 2. **语音消息** (`useVoice.ts`)
- ✅ 发送语音时调用`addMessage`保存到IndexedDB
- ✅ 已有`chatId`参数，修复依赖项

### 3. **位置消息** (`useLocationMsg.ts`)
- ✅ 发送位置时调用`addMessage`保存到IndexedDB
- ✅ 已有`chatId`参数，修复依赖项

### 4. **照片消息** (`usePhoto.ts`)
- ✅ 发送照片时调用`addMessage`保存到IndexedDB
- ✅ 已有`chatId`参数，修复依赖项

### 5. **撤回消息** (`ChatDetail.tsx`)
- ✅ 撤回消息时从IndexedDB加载完整消息列表
- ✅ 更新撤回状态后调用`saveMessages`保存
- ✅ 导入`loadMessages`和`saveMessages`

## 修改的文件

1. `src/pages/ChatDetail/hooks/useTransfer.ts`
   - 添加`chatId`参数
   - 发送转账保存到IndexedDB
   - 接收/退还转账保存到IndexedDB

2. `src/pages/ChatDetail/hooks/useVoice.ts`
   - 发送语音保存到IndexedDB

3. `src/pages/ChatDetail/hooks/useLocationMsg.ts`
   - 发送位置保存到IndexedDB

4. `src/pages/ChatDetail/hooks/usePhoto.ts`
   - 发送照片保存到IndexedDB

5. `src/pages/ChatDetail.tsx`
   - 修改`useTransfer`调用，传入`chatId`
   - 撤回消息保存到IndexedDB
   - 导入消息管理函数

## 技术说明

### IndexedDB存储
- 使用`simpleMessageManager.ts`统一管理消息
- 支持大容量存储（几百MB到GB）
- 内存缓存 + 持久化双重保障

### 保存时机
- **添加单条消息**：使用`addMessage(chatId, message)`
- **批量更新消息**：使用`saveMessages(chatId, messages)`
- **立即生效**：同时更新缓存和IndexedDB

### 消息流程
```
用户操作 
  ↓
创建消息对象
  ↓
保存到IndexedDB (addMessage/saveMessages)
  ↓
更新React状态 (setMessages)
  ↓
界面显示
```

## 测试验证

### 测试步骤
1. 发送转账、语音、位置、照片消息
2. 撤回一条消息
3. 刷新页面或关闭重开
4. 验证所有消息都还在

### 预期结果
- ✅ 所有消息类型都能正常保存
- ✅ 刷新页面后消息不丢失
- ✅ 关闭窗口重开后消息还在
- ✅ 转账状态（已收/已退还）正确保存

## 其他已正常工作的功能

以下功能已经正确保存到IndexedDB，不需要修改：

- ✅ 普通文本消息 (`useChatAI.ts`)
- ✅ 视频通话记录 (`useVideoCall.ts`)
- ✅ 情侣空间消息 (`useCoupleSpace.ts`)
- ✅ AI指令消息 (`commandHandlers.ts`)
- ✅ 转发消息 (`useForward.ts`)
- ✅ 表情包 (`useEmoji.ts`)
- ✅ AI主动发消息 (`useProactiveMessage.ts`)

## 注意事项

1. **必须同时保存到IndexedDB和React状态**
   - IndexedDB：持久化存储
   - React状态：界面显示

2. **使用正确的保存函数**
   - 新增消息：`addMessage(chatId, message)`
   - 更新消息：`saveMessages(chatId, messages)`

3. **确保chatId参数传递**
   - 所有hooks都需要`chatId`参数
   - 才能正确保存到对应的聊天记录

## 修复日期
2025-01-09
