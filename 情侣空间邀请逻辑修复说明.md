# 情侣空间邀请逻辑修复

## 🐛 修复的问题

**用户遇到的Bug**：
1. AI给用户发了情侣空间邀请（pending状态）
2. 用户没接受，去解除了关系
3. 用户想给AI发邀请，系统提示"对方给我发了邀请待接受"
4. 但那个邀请卡片已经不见了，用户发不出去邀请

**根本原因**：
- 旧逻辑：只要有`pending`、`active`或`rejected`状态，就阻止发送新邀请
- 问题：没有区分是谁发的邀请！AI发的pending邀请会阻止用户发邀请

---

## ✅ 修复方案

### 1. 添加sender字段

在`CoupleSpaceRelation`接口中添加：
```typescript
sender: 'user' | 'character'  // 标识是谁发起的邀请
```

### 2. 修改创建邀请逻辑

```typescript
export const createCoupleSpaceInvite = (
  userId: string,
  characterId: string,
  characterName: string,
  characterAvatar?: string,
  sender: 'user' | 'character' = 'user'  // ✅ 新增参数
)
```

**新逻辑**：
- ✅ 只有`active`状态才阻止创建新邀请
- ✅ `pending`状态可以被覆盖（用户可以反向发邀请）
- ✅ `rejected`状态可以重新发送

### 3. 修改发送权限检查

```typescript
export const canSendCoupleSpaceInvite = (): boolean => {
  const relation = getCoupleSpaceRelation()
  
  if (!relation) return true
  
  // ✅ 只有active状态才阻止发送邀请
  // pending状态：可以覆盖（用户可以反向发邀请）
  // rejected状态：可以重新发送
  if (relation.status === 'active') {
    return false
  }
  
  return true
}
```

---

## 📝 修改的文件

1. **G:\douzhi\src\utils\coupleSpaceUtils.ts**
   - 接口添加`sender`字段
   - `createCoupleSpaceInvite`添加`sender`参数
   - 修改邀请创建逻辑
   - 修改`canSendCoupleSpaceInvite`逻辑

2. **G:\douzhi\src\pages\ChatDetail\hooks\useCoupleSpace.ts**
   - 用户发送邀请时传入`'user'`

3. **G:\douzhi\src\pages\ChatDetail\hooks\commandHandlers.ts**
   - AI发送邀请时传入`'character'`

---

## 🎯 修复后的行为

### 场景1：AI先发邀请，用户想反向发邀请

**修复前** ❌：
```
1. AI发送邀请 → pending状态
2. 用户想发邀请 → 被阻止："对方给我发了邀请待接受"
3. 用户无法发送
```

**修复后** ✅：
```
1. AI发送邀请 → pending状态（sender='character'）
2. 用户想发邀请 → 可以发送！
3. 用户发送 → 覆盖旧邀请（sender='user'）
4. 现在是用户发的邀请，等待AI接受
```

### 场景2：双方都接受了（active状态）

```
1. 情侣空间已激活 → active状态
2. 任何人发送邀请 → 被阻止："已存在活跃的情侣空间"
3. ✅ 正确！双方确认后不应该再发邀请
```

### 场景3：用户拒绝了邀请（rejected状态）

**修复前** ❌：
```
1. AI发送邀请
2. 用户拒绝 → rejected状态
3. 用户想重新发邀请 → 被阻止
```

**修复后** ✅：
```
1. AI发送邀请
2. 用户拒绝 → rejected状态
3. 用户想重新发邀请 → 可以发送！
4. 发送成功，覆盖旧的rejected状态
```

---

## 🧪 测试场景

### 测试1：AI发邀请 → 用户反向发邀请
1. AI发送情侣空间邀请
2. 用户**不接受**
3. 用户自己发送情侣空间邀请
4. **预期**：✅ 可以发送，覆盖AI的邀请

### 测试2：用户发邀请 → AI回复后 → 用户再发
1. 用户发送邀请
2. AI拒绝
3. 用户再次发送
4. **预期**：✅ 可以发送，覆盖rejected状态

### 测试3：双方已建立情侣空间
1. 双方接受邀请，情侣空间激活
2. 任意一方尝试发送新邀请
3. **预期**：❌ 不能发送，提示"已存在活跃的情侣空间"

---

## 💡 关键改进

1. **区分发起方**：明确是用户还是AI发起的邀请
2. **允许覆盖pending**：对方的pending邀请不阻止我发邀请
3. **允许重试rejected**：被拒绝后可以重新发送
4. **只有active阻止**：只有双方确认的关系才阻止新邀请

---

## ⚠️ 注意事项

1. **旧数据兼容性**
   - 旧的relation数据没有sender字段
   - 代码会使用默认值'user'
   - 建议用户清空旧邀请重新发送

2. **清空旧数据命令**
   ```javascript
   // 在浏览器控制台运行
   localStorage.removeItem('couple_space_relation')
   ```

3. **未来优化方向**
   - 可以显示"对方也给你发了邀请"的提示
   - 可以让用户选择接受哪个邀请
   - 可以支持双向邀请同时存在

---

**修复完成！现在AI的邀请不会阻止用户发邀请了！** 🎉
