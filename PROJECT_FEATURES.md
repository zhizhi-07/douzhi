# 🎉 豆汁 - 项目功能完整文档

> AI社交模拟器 | 微信风格 | React + TypeScript + Vite

---

## 📊 项目概览

| 项目名称 | 豆汁 (Douzhi) |
|---------|-------------|
| 项目类型 | Web应用 |
| 核心框架 | React 18 + TypeScript + Vite |
| 设计风格 | 微信风格 + 液态玻璃UI |
| 核心功能 | AI角色社交模拟 |
| 存储方案 | IndexedDB + 本地缓存 |

---

## ✨ 核心功能模块

### 1️⃣ AI聊天系统

#### 私聊功能
- **单对单聊天** - 与AI角色进行私密对话
- **AI自动回复** - 基于角色人设的智能回复
- **消息引用** - 使用 `[引用:消息内容]` 指令引用历史消息
- **消息撤回** - 支持用户和AI撤回消息
- **重新生成** - 重新生成AI回复（真正删除，不会恢复）
- **AI记忆系统** - IndexedDB持久化，记住聊天历史
- **拉黑功能** - 拉黑后消息显示感叹号标记，AI感知拉黑状态

#### 群聊功能
- **多人聊天** - 支持多个AI角色在同一群聊中
- **AI导演系统** - 一次API调用生成完整剧本
  - 关系分析
  - 情节构思
  - 多角色台词
- **消息延迟显示** - 1.5秒间隔模拟真实对话
- **私聊同步** - 群聊AI可以看到每个成员与用户的私聊记录
- **特殊指令支持**
  - `[表情:编号]` - 发送表情包
  - `[撤回:msg_xxx]` - 撤回消息
  - `[踢出:成员名]` - 踢出成员
  - `[群公告:内容]` - 修改群公告

---

### 2️⃣ 朋友圈系统

#### 发布功能
- **文字+图片发布** - 支持多张图片
- **朋友圈管理** - 查看、编辑、删除

#### AI互动
- **自动点赞** - AI自动对用户朋友圈点赞
- **自动评论** - AI自动对用户朋友圈评论
- **主动发布** - AI主动发布朋友圈
- **评论连锁反应** - AI之间互相评论
- **朋友圈导演系统** - 多AI协作互动

#### 上下文同步
- 朋友圈内容与私聊/群聊上下文同步
- AI可以在聊天中引用朋友圈内容

---

### 3️⃣ 消息类型系统

| 消息类型 | 功能说明 |
|---------|---------|
| 📝 文字消息 | 基础聊天消息 |
| 🎤 语音消息 | 模拟语音（带时长） |
| 🖼️ 图片消息 | 带图片描述 |
| 📍 位置消息 | 地理位置分享 |
| 💰 转账消息 | 模拟转账 |
| 🎁 红包消息 | 模拟红包 |
| 😄 表情包 | 表情包系统 |
| 📞 视频通话 | 视频通话请求 |

---

### 4️⃣ 视频通话功能

- **通话模拟** - AI视频通话模拟
- **通话记录** - 自动保存通话记录
- **通话时长** - 显示通话时长
- **通话内容** - 记录通话内容
- **操作支持** - 接听/拒绝/挂断

---

### 5️⃣ 角色管理系统

#### 角色创建
- **自定义创建** - 创建自定义AI角色
- **Character Card导入** - 支持PNG/JSON格式导入
- **头像设置** - 自定义角色头像
- **昵称/签名** - 设置角色昵称和签名
- **人设描述** - 详细的角色人设

#### AI自主修改
- **修改网名** - AI可以自主修改自己的昵称
- **修改签名** - AI可以自主修改自己的签名
- **指令支持** - `[修改网名:新昵称]` / `[修改签名:新签名]`

#### 角色管理
- **角色列表** - 查看所有角色
- **角色详情** - 查看角色信息
- **角色删除** - 删除不需要的角色

---

### 6️⃣ 时间戳系统

#### 显示规则
- **5分钟固定刻度** - 10:00, 10:05, 10:10...
- **今天/昨天智能显示** - 自动判断日期
- **样式美化** - 精心设计的时间戳样式

#### 算法原理
```
计算5分钟时间段 = Math.floor(timestamp / (5 * 60 * 1000))
跨越时间段才显示时间戳
```

---

### 7️⃣ 消息管理系统

#### 存储方案
- **IndexedDB持久化** - 大容量本地存储
- **消息缓存优化** - 内存缓存 + 数据库缓存
- **消息加载优化** - 异步加载，不阻塞UI

#### 消息处理
- **消息ID去重** - 防止重复消息
- **真正删除** - 重新生成时真正从数据库删除
- **消息同步** - 多标签页消息同步

---

### 8️⃣ 黑名单功能

#### 功能特性
- **拉黑/取消拉黑** - 灵活的黑名单管理
- **UI标记** - 拉黑消息显示感叹号 ⚠️
- **AI感知** - AI能感知拉黑状态，调整回复
- **消息保存** - 拉黑消息依然发送和保存

#### 提示词优化
- AI提示词中包含拉黑警告
- AI可以根据拉黑状态调整回复内容

---

### 9️⃣ 音效系统

#### 音效类型
- **发送消息音效** - 用户发送时播放
- **接收消息音效** - 接收AI回复时播放
- **可爱风格** - 精心选择的可爱音效

#### 音效控制
- **开关控制** - 可以开启/关闭音效
- **音量调节** - 支持音量调节
- **静音模式** - 支持静音

---

## 🎯 特殊指令系统

### 私聊指令
```
[引用:消息内容]      - 引用历史消息
[视频通话]          - 发起视频通话
[修改网名:新昵称]    - AI修改自己的昵称
[修改签名:新签名]    - AI修改自己的签名
```

### 群聊指令
```
[表情:编号]         - 发送表情包
quotedMessageId     - 引用消息（使用消息ID）
[撤回:msg_xxx]      - 撤回消息
[踢出:成员名]       - 踢出成员（管理员）
[群公告:内容]       - 修改群公告（管理员）
```

### 朋友圈指令
```
AI自动发布朋友圈
AI自动点赞评论
评论连锁反应
```

---

## 📈 性能优化方案

### 1. 虚拟滚动
- **只渲染30条消息** - 大幅减少DOM节点
- **上下预加载5条** - 流畅滚动体验
- **减少90%DOM节点** - 显著提升性能

### 2. 消息缓存
```typescript
// 内存缓存 + 数据库缓存
const messageCache = new Map<string, Message[]>()
// 优先读缓存，异步更新数据库
```

### 3. 日志优化
- **条件化日志** - 仅在开发环境执行
- **生产环境无日志** - 避免主线程阻塞
- **移除20+个console.log** - 显著提升性能

### 4. AI回复优化
- **群聊延迟显示** - 1.5秒间隔模拟真实
- **阻止事件触发** - AI回复期间忽略storage事件
- **一次API调用** - 生成完整剧本

### 5. 加载优化
- **骨架屏加载** - 提升用户体验
- **异步消息加载** - 不阻塞初始渲染
- **懒加载** - 按需加载资源

---

## 📁 核心文件结构

```
src/
├── pages/
│   ├── ChatDetail.tsx              # 私聊页面
│   ├── GroupChatDetail.tsx         # 群聊页面
│   ├── Moments.tsx                 # 朋友圈页面
│   ├── CharacterList.tsx           # 角色列表
│   └── ChatDetail/
│       ├── components/
│       │   ├── MessageItem.tsx      # 消息项（React.memo优化）
│       │   ├── MessageList.tsx      # 消息列表
│       │   ├── VirtualMessageList.tsx # 虚拟滚动列表
│       │   └── LoadingSkeleton.tsx  # 加载骨架屏
│       └── hooks/
│           ├── useChatAI.ts         # 私聊AI逻辑
│           ├── useChatState.ts      # 聊天状态管理
│           ├── useMessageVirtualization.ts # 虚拟滚动Hook
│           └── commandHandlers.ts   # 指令处理器
│
├── components/
│   ├── AIMemoModal.tsx              # AI备忘录
│   ├── EmojiPanel.tsx               # 表情包面板
│   ├── MusicPlayerCard.tsx          # 音乐播放器
│   ├── VideoCallScreen.tsx          # 视频通话屏幕
│   └── ... (40+ 其他组件)
│
└── utils/
    ├── chatApi.ts                   # AI聊天API（条件化日志）
    ├── groupChatApi.ts              # 群聊AI API
    ├── groupChatManager.ts          # 群聊管理器
    ├── simpleMessageManager.ts      # 消息管理器
    ├── momentsAI.ts                 # 朋友圈AI互动
    ├── blacklistManager.ts          # 黑名单管理器
    ├── soundManager.ts              # 音效管理器
    └── performanceOptimizer.ts      # 性能优化工具
```

---

## 🔧 技术栈

| 技术 | 版本 | 用途 |
|-----|------|------|
| React | 18.2.0 | UI框架 |
| TypeScript | 5.2.2 | 类型系统 |
| Vite | 5.0.8 | 构建工具 |
| React Router | 6.20.0 | 路由管理 |
| TailwindCSS | 3.3.6 | 样式框架 |
| Leaflet | 1.9.4 | 地图库 |
| IndexedDB | 原生 | 本地存储 |

---

## 🎨 设计特点

### UI风格
- **微信风格** - 熟悉的社交应用界面
- **液态玻璃** - 毛玻璃效果，现代感
- **iOS风格** - 圆润、精致、小巧
- **流畅动画** - cubic-bezier缓动，0.3s过渡

### 颜色系统
- 玻璃背景：`rgba(255, 255, 255, 0.15)`
- 模糊强度：`blur(20px)`
- 边框高光：`rgba(255, 255, 255, 0.2)`
- 投影：`0 8px 32px rgba(0, 0, 0, 0.1)`

---

## 🐛 已修复的重要Bug

| Bug | 原因 | 解决方案 |
|-----|------|---------|
| 重新生成消息恢复 | 只更新React状态 | 使用saveMessages覆盖数据库 |
| 群聊消息一次性显示 | storage事件触发 | 设置isAIReplying标志 |
| 引用消息背景色混淆 | 继承父元素背景 | 统一使用灰色背景 |
| 时间戳显示混乱 | 简单的间隔判断 | 改为计算时间段 |
| 表情包重复保存 | 多次触发保存 | 优化保存逻辑去重 |
| 消息卡顿 | 无条件console.log | 条件化日志 + 虚拟滚动 |

---

## 📊 API调用流程

### 私聊流程
```
用户发言
  ↓
构建提示词（包含拉黑状态）
  ↓
调用AI API
  ↓
解析指令（引用/视频通话/修改网名等）
  ↓
保存消息到IndexedDB
  ↓
更新UI
```

### 群聊流程
```
用户发言
  ↓
构建完整提示词（包含私聊记录）
  ↓
一次API调用生成剧本
  ↓
解析剧本（关系+情节+台词）
  ↓
逐条显示消息（1.5秒间隔）
  ↓
执行特殊指令
```

### 朋友圈流程
```
用户发布朋友圈
  ↓
保存到IndexedDB
  ↓
触发AI互动
  ↓
AI点赞/评论
  ↓
评论连锁反应
```

---

## 💡 使用建议

### 最佳实践
1. **创建多样化的角色** - 3-5个常用角色
2. **善用群聊功能** - 启用私聊同步增强真实感
3. **体验朋友圈功能** - 观察AI的互动
4. **管理API消耗** - 群聊比私聊消耗更多

### 注意事项
1. **数据管理** - 定期清理不需要的聊天记录
2. **API配置** - 确保API配置正确
3. **功能开关** - 不需要的功能可以关闭

---

## 🚀 快速开始

```bash
# 安装依赖
npm install

# 启动开发服务器
npm run dev

# 构建生产版本
npm run build

# 预览生产版本
npm run preview
```

---

## 📈 项目统计

| 指标 | 数值 |
|-----|------|
| 总代码行数 | ~15,000行 |
| 核心组件数 | 40+ |
| 工具函数数 | 50+ |
| 文档数量 | 50+ |
| 功能模块数 | 9个 |
| 特殊指令数 | 10+ |

---

## 🎉 项目总结

**豆汁**是一个功能完整、体验优秀的AI社交模拟器，实现了：

✅ **完整的聊天系统** - 私聊、群聊、朋友圈  
✅ **智能的AI系统** - 导演系统、记忆系统、上下文同步  
✅ **丰富的消息类型** - 文字、图片、语音、视频通话  
✅ **真实的社交体验** - 引用、撤回、拉黑、时间戳  
✅ **优秀的性能** - 虚拟滚动、缓存优化、条件化日志  
✅ **完善的文档** - 功能说明、修复报告、使用指南  

所有核心功能已完整实现并经过测试，可以立即使用！🎊

---

**最后更新**: 2025年11月13日  
**项目状态**: ✅ 完成  
**维护状态**: 🔄 持续优化
