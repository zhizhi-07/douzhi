<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¶ˆæ¯æŒä¹…åŒ–æµ‹è¯•</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 10px;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 5px;
        }
        .test-title {
            font-weight: bold;
            color: #2196F3;
            margin-bottom: 10px;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        button:hover {
            background: #45a049;
        }
        button.danger {
            background: #f44336;
        }
        button.danger:hover {
            background: #da190b;
        }
        .log {
            background: #263238;
            color: #aed581;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        .success {
            color: #4CAF50;
            font-weight: bold;
        }
        .error {
            color: #f44336;
            font-weight: bold;
        }
        .warning {
            color: #ff9800;
            font-weight: bold;
        }
        .info {
            color: #2196F3;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ èŠå¤©è®°å½•æŒä¹…åŒ–æµ‹è¯•å·¥å…·</h1>
        
        <div class="test-section">
            <div class="test-title">ğŸ“Š æµ‹è¯•çŠ¶æ€</div>
            <div id="status">å‡†å¤‡å°±ç»ª</div>
        </div>

        <div class="test-section">
            <div class="test-title">ğŸ§ª å¹¶å‘ä¿å­˜æµ‹è¯•</div>
            <button onclick="testConcurrentSave()">æµ‹è¯•å¹¶å‘ä¿å­˜</button>
            <button onclick="testRapidSave()">æµ‹è¯•å¿«é€Ÿè¿ç»­ä¿å­˜</button>
            <button onclick="testLargeBatch()">æµ‹è¯•å¤§æ‰¹é‡æ¶ˆæ¯</button>
        </div>

        <div class="test-section">
            <div class="test-title">ğŸ’¾ å­˜å‚¨éªŒè¯</div>
            <button onclick="verifyStorage()">éªŒè¯å­˜å‚¨å®Œæ•´æ€§</button>
            <button onclick="checkBackup()">æ£€æŸ¥å¤‡ä»½æœºåˆ¶</button>
            <button onclick="testRecovery()">æµ‹è¯•æ¢å¤æœºåˆ¶</button>
        </div>

        <div class="test-section">
            <div class="test-title">ğŸ”„ é¡µé¢ç”Ÿå‘½å‘¨æœŸæµ‹è¯•</div>
            <button onclick="simulatePageHide()">æ¨¡æ‹Ÿé¡µé¢éšè—</button>
            <button onclick="simulatePageReload()">æ¨¡æ‹Ÿé¡µé¢åˆ·æ–°</button>
            <button onclick="simulateCrash()">æ¨¡æ‹Ÿå¼‚å¸¸é€€å‡º</button>
        </div>

        <div class="test-section">
            <div class="test-title">ğŸ—‘ï¸ æ¸…ç†å·¥å…·</div>
            <button class="danger" onclick="clearTestData()">æ¸…é™¤æµ‹è¯•æ•°æ®</button>
            <button class="danger" onclick="clearAllBackups()">æ¸…é™¤æ‰€æœ‰å¤‡ä»½</button>
        </div>

        <div class="test-section">
            <div class="test-title">ğŸ“ æµ‹è¯•æ—¥å¿—</div>
            <div id="log" class="log"></div>
        </div>
    </div>

    <script>
        const TEST_CHAT_ID = 'test_chat_persistence';
        let logElement = document.getElementById('log');
        let statusElement = document.getElementById('status');

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const className = type;
            const entry = `<div class="${className}">[${timestamp}] ${message}</div>`;
            logElement.innerHTML += entry;
            logElement.scrollTop = logElement.scrollHeight;
        }

        function updateStatus(status, type = 'info') {
            statusElement.innerHTML = `<span class="${type}">${status}</span>`;
        }

        // ç”Ÿæˆæµ‹è¯•æ¶ˆæ¯
        function generateTestMessage(index) {
            return {
                id: Date.now() * 10000 + index,
                type: index % 2 === 0 ? 'sent' : 'received',
                content: `æµ‹è¯•æ¶ˆæ¯ #${index} - ${new Date().toISOString()}`,
                time: new Date().toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' }),
                timestamp: Date.now()
            };
        }

        // æµ‹è¯•å¹¶å‘ä¿å­˜
        async function testConcurrentSave() {
            log('å¼€å§‹å¹¶å‘ä¿å­˜æµ‹è¯•...', 'info');
            updateStatus('æ­£åœ¨æµ‹è¯•å¹¶å‘ä¿å­˜...', 'warning');

            const promises = [];
            for (let i = 0; i < 10; i++) {
                promises.push(new Promise((resolve) => {
                    setTimeout(() => {
                        const messages = [];
                        for (let j = 0; j < 5; j++) {
                            messages.push(generateTestMessage(i * 5 + j));
                        }
                        
                        // æ¨¡æ‹Ÿä¿å­˜æ“ä½œ
                        localStorage.setItem(`test_concurrent_${i}`, JSON.stringify({
                            messages,
                            timestamp: Date.now()
                        }));
                        
                        log(`å¹¶å‘ä»»åŠ¡ ${i + 1} å®Œæˆï¼Œä¿å­˜äº† ${messages.length} æ¡æ¶ˆæ¯`, 'success');
                        resolve();
                    }, Math.random() * 100);
                }));
            }

            await Promise.all(promises);
            log('å¹¶å‘ä¿å­˜æµ‹è¯•å®Œæˆï¼', 'success');
            updateStatus('å¹¶å‘ä¿å­˜æµ‹è¯•é€šè¿‡ âœ…', 'success');
        }

        // æµ‹è¯•å¿«é€Ÿè¿ç»­ä¿å­˜
        async function testRapidSave() {
            log('å¼€å§‹å¿«é€Ÿè¿ç»­ä¿å­˜æµ‹è¯•...', 'info');
            updateStatus('æ­£åœ¨æµ‹è¯•å¿«é€Ÿè¿ç»­ä¿å­˜...', 'warning');

            for (let i = 0; i < 20; i++) {
                const message = generateTestMessage(i);
                
                // æ¨¡æ‹Ÿå¿«é€Ÿä¿å­˜
                const key = `test_rapid_${TEST_CHAT_ID}`;
                const existing = localStorage.getItem(key);
                const messages = existing ? JSON.parse(existing).messages : [];
                messages.push(message);
                
                localStorage.setItem(key, JSON.stringify({
                    messages,
                    timestamp: Date.now()
                }));
                
                if (i % 5 === 0) {
                    log(`å·²ä¿å­˜ ${i + 1}/20 æ¡æ¶ˆæ¯`, 'info');
                }
                
                await new Promise(resolve => setTimeout(resolve, 10));
            }

            log('å¿«é€Ÿè¿ç»­ä¿å­˜æµ‹è¯•å®Œæˆï¼', 'success');
            updateStatus('å¿«é€Ÿè¿ç»­ä¿å­˜æµ‹è¯•é€šè¿‡ âœ…', 'success');
        }

        // æµ‹è¯•å¤§æ‰¹é‡æ¶ˆæ¯
        async function testLargeBatch() {
            log('å¼€å§‹å¤§æ‰¹é‡æ¶ˆæ¯æµ‹è¯•...', 'info');
            updateStatus('æ­£åœ¨æµ‹è¯•å¤§æ‰¹é‡æ¶ˆæ¯...', 'warning');

            const messages = [];
            const batchSize = 100;
            
            for (let i = 0; i < batchSize; i++) {
                messages.push(generateTestMessage(i));
            }

            const startTime = Date.now();
            
            // æ¨¡æ‹Ÿä¿å­˜å¤§æ‰¹é‡æ¶ˆæ¯
            localStorage.setItem(`test_batch_${TEST_CHAT_ID}`, JSON.stringify({
                messages,
                timestamp: Date.now()
            }));

            const endTime = Date.now();
            const duration = endTime - startTime;

            log(`æˆåŠŸä¿å­˜ ${batchSize} æ¡æ¶ˆæ¯ï¼Œè€—æ—¶ ${duration}ms`, 'success');
            updateStatus('å¤§æ‰¹é‡æ¶ˆæ¯æµ‹è¯•é€šè¿‡ âœ…', 'success');
        }

        // éªŒè¯å­˜å‚¨å®Œæ•´æ€§
        function verifyStorage() {
            log('å¼€å§‹éªŒè¯å­˜å‚¨å®Œæ•´æ€§...', 'info');
            updateStatus('æ­£åœ¨éªŒè¯å­˜å‚¨...', 'warning');

            let totalMessages = 0;
            let corruptedData = 0;
            
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith('test_')) {
                    try {
                        const data = JSON.parse(localStorage.getItem(key));
                        if (data.messages && Array.isArray(data.messages)) {
                            totalMessages += data.messages.length;
                            log(`âœ“ ${key}: ${data.messages.length} æ¡æ¶ˆæ¯`, 'success');
                        } else {
                            corruptedData++;
                            log(`âœ— ${key}: æ•°æ®æ ¼å¼é”™è¯¯`, 'error');
                        }
                    } catch (e) {
                        corruptedData++;
                        log(`âœ— ${key}: JSONè§£æå¤±è´¥`, 'error');
                    }
                }
            }

            if (corruptedData === 0) {
                log(`å­˜å‚¨å®Œæ•´æ€§éªŒè¯é€šè¿‡ï¼å…± ${totalMessages} æ¡æ¶ˆæ¯`, 'success');
                updateStatus('å­˜å‚¨å®Œæ•´æ€§éªŒè¯é€šè¿‡ âœ…', 'success');
            } else {
                log(`å‘ç° ${corruptedData} ä¸ªæŸåçš„æ•°æ®é¡¹`, 'error');
                updateStatus('å­˜å‚¨å®Œæ•´æ€§éªŒè¯å¤±è´¥ âŒ', 'error');
            }
        }

        // æ£€æŸ¥å¤‡ä»½æœºåˆ¶
        function checkBackup() {
            log('æ£€æŸ¥å¤‡ä»½æœºåˆ¶...', 'info');
            updateStatus('æ­£åœ¨æ£€æŸ¥å¤‡ä»½...', 'warning');

            let backupCount = 0;
            
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith('msg_backup_')) {
                    backupCount++;
                    try {
                        const data = JSON.parse(localStorage.getItem(key));
                        const age = Date.now() - data.timestamp;
                        const ageMinutes = Math.floor(age / 60000);
                        log(`å¤‡ä»½: ${key} (${ageMinutes} åˆ†é’Ÿå‰)`, 'info');
                    } catch (e) {
                        log(`æŸåçš„å¤‡ä»½: ${key}`, 'error');
                    }
                }
            }

            if (backupCount > 0) {
                log(`æ‰¾åˆ° ${backupCount} ä¸ªå¤‡ä»½`, 'success');
                updateStatus(`å¤‡ä»½æœºåˆ¶æ­£å¸¸ (${backupCount} ä¸ªå¤‡ä»½) âœ…`, 'success');
            } else {
                log('æœªæ‰¾åˆ°ä»»ä½•å¤‡ä»½', 'warning');
                updateStatus('æ— å¤‡ä»½æ•°æ® âš ï¸', 'warning');
            }
        }

        // æµ‹è¯•æ¢å¤æœºåˆ¶
        async function testRecovery() {
            log('å¼€å§‹æµ‹è¯•æ¢å¤æœºåˆ¶...', 'info');
            updateStatus('æ­£åœ¨æµ‹è¯•æ¢å¤...', 'warning');

            // åˆ›å»ºæµ‹è¯•æ•°æ®
            const testData = {
                messages: [
                    generateTestMessage(1),
                    generateTestMessage(2),
                    generateTestMessage(3)
                ],
                timestamp: Date.now()
            };

            // ä¿å­˜åˆ°å¤‡ä»½
            const backupKey = `msg_backup_test_recovery`;
            localStorage.setItem(backupKey, JSON.stringify(testData));
            log('å·²åˆ›å»ºæµ‹è¯•å¤‡ä»½', 'info');

            // æ¨¡æ‹Ÿæ¢å¤
            await new Promise(resolve => setTimeout(resolve, 100));
            
            const recovered = localStorage.getItem(backupKey);
            if (recovered) {
                const data = JSON.parse(recovered);
                if (data.messages && data.messages.length === 3) {
                    log(`æˆåŠŸæ¢å¤ ${data.messages.length} æ¡æ¶ˆæ¯`, 'success');
                    updateStatus('æ¢å¤æœºåˆ¶æµ‹è¯•é€šè¿‡ âœ…', 'success');
                } else {
                    log('æ¢å¤çš„æ•°æ®ä¸å®Œæ•´', 'error');
                    updateStatus('æ¢å¤æœºåˆ¶æµ‹è¯•å¤±è´¥ âŒ', 'error');
                }
            } else {
                log('æ— æ³•æ¢å¤å¤‡ä»½', 'error');
                updateStatus('æ¢å¤æœºåˆ¶æµ‹è¯•å¤±è´¥ âŒ', 'error');
            }
        }

        // æ¨¡æ‹Ÿé¡µé¢éšè—
        function simulatePageHide() {
            log('æ¨¡æ‹Ÿé¡µé¢éšè—äº‹ä»¶...', 'info');
            document.dispatchEvent(new Event('visibilitychange'));
            log('é¡µé¢éšè—äº‹ä»¶å·²è§¦å‘', 'success');
            updateStatus('é¡µé¢éšè—æµ‹è¯•å®Œæˆ âœ…', 'success');
        }

        // æ¨¡æ‹Ÿé¡µé¢åˆ·æ–°
        function simulatePageReload() {
            log('å°†åœ¨3ç§’ååˆ·æ–°é¡µé¢...', 'warning');
            updateStatus('å‡†å¤‡åˆ·æ–°é¡µé¢...', 'warning');
            setTimeout(() => {
                location.reload();
            }, 3000);
        }

        // æ¨¡æ‹Ÿå¼‚å¸¸é€€å‡º
        function simulateCrash() {
            log('æ¨¡æ‹Ÿå¼‚å¸¸é€€å‡º...', 'warning');
            window.dispatchEvent(new Event('beforeunload'));
            log('beforeunload äº‹ä»¶å·²è§¦å‘', 'success');
            updateStatus('å¼‚å¸¸é€€å‡ºæ¨¡æ‹Ÿå®Œæˆ âœ…', 'success');
        }

        // æ¸…é™¤æµ‹è¯•æ•°æ®
        function clearTestData() {
            if (!confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰æµ‹è¯•æ•°æ®å—ï¼Ÿ')) return;
            
            log('æ¸…é™¤æµ‹è¯•æ•°æ®...', 'warning');
            let count = 0;
            
            const keysToRemove = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith('test_')) {
                    keysToRemove.push(key);
                }
            }
            
            keysToRemove.forEach(key => {
                localStorage.removeItem(key);
                count++;
            });
            
            log(`å·²æ¸…é™¤ ${count} ä¸ªæµ‹è¯•æ•°æ®é¡¹`, 'success');
            updateStatus('æµ‹è¯•æ•°æ®å·²æ¸…é™¤ âœ…', 'success');
        }

        // æ¸…é™¤æ‰€æœ‰å¤‡ä»½
        function clearAllBackups() {
            if (!confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰å¤‡ä»½å—ï¼Ÿè¿™å¯èƒ½ä¼šå½±å“æ¶ˆæ¯æ¢å¤ï¼')) return;
            
            log('æ¸…é™¤æ‰€æœ‰å¤‡ä»½...', 'warning');
            let count = 0;
            
            const keysToRemove = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith('msg_backup_')) {
                    keysToRemove.push(key);
                }
            }
            
            keysToRemove.forEach(key => {
                localStorage.removeItem(key);
                count++;
            });
            
            log(`å·²æ¸…é™¤ ${count} ä¸ªå¤‡ä»½`, 'success');
            updateStatus('å¤‡ä»½å·²æ¸…é™¤ âœ…', 'success');
        }

        // åˆå§‹åŒ–
        log('æµ‹è¯•å·¥å…·å·²åŠ è½½', 'success');
        log('ç‚¹å‡»æŒ‰é’®å¼€å§‹æµ‹è¯•å„é¡¹åŠŸèƒ½', 'info');
    </script>
</body>
</html>
