# 群聊基础功能实现说明

## ✅ 已完成功能

### 1. 核心文件创建

#### `src/utils/groupMessageParser.ts`
**功能**：解析AI返回的群聊消息

- `parseGroupChatResponse()` - 解析 `[成员名] 内容` 格式的简单回复
- `extractGroupChatScript()` - 解析JSON格式的剧本数据
- 支持导演剧本模式的完整解析

#### `src/utils/groupChatApi.ts`
**功能**：群聊AI调用逻辑

- `buildGroupChatPrompt()` - 构建群聊AI提示词
  - 包含群聊信息（群名、时间、成员数）
  - 包含所有成员的性格描述
  - 包含最近20条聊天记录
  - 完整的导演剧本创作指导
- `generateGroupChatReply()` - 调用AI生成群聊回复
  - 使用 `callAIApi` 和 `getApiSettings`
  - 返回解析后的剧本数据

#### `src/pages/GroupChatDetail.tsx`
**功能**：群聊详情页面（已集成AI回复）

**新增功能**：
- AI回复逻辑集成
- AI正在输入状态提示
- 输入框禁用（AI回复时）
- 逐条显示AI消息（间隔2秒）

---

## 🎯 工作流程

### 用户发送消息后的流程

1. **用户发送消息**
   - 保存用户消息到群聊
   - 清空输入框
   - 触发AI回复

2. **构建AI请求**
   - 获取群聊信息（群名、成员列表）
   - 获取聊天历史（最近消息）
   - 构建成员信息（包含性格描述）

3. **调用AI生成回复**
   - 使用导演剧本模式提示词
   - AI推演角色关系
   - AI构思情节
   - AI编排对话剧本
   - 返回JSON格式剧本

4. **解析并显示回复**
   - 解析JSON格式的actions数组
   - 逐条显示AI消息（间隔2秒）
   - 每条消息自动保存到群聊
   - 自动滚动到底部

---

## 📝 提示词特点

### 融合设计
- **雾项目优势**：导演剧本模式、关系推演、口语化要求
- **章鱼优势**：严格输出格式、数量控制、公共事件感知

### 核心要求
1. **三步创作法**
   - 推演角色关系
   - 构思完整故事
   - 编排对话剧本

2. **输出格式**
   - JSON格式：`{"relationships": "...", "plot": "...", "actions": [...]}`
   - 每条消息：`{"actorName": "角色名", "content": "台词"}`

3. **数量控制**
   - 基础规则：群成员数 × (2到4) 条消息
   - 灵活分配：主要参与者多说，次要参与者少说

4. **口语化要求**
   - 每条5-20字
   - 像真人打字
   - 可以连续发言
   - 符合角色性格

---

## 🎨 UI特性

### 消息显示
- 用户消息：右侧，绿色气泡
- AI消息：左侧，白色气泡
- 显示发送者头像和名称

### AI输入状态
- 三个跳动的小圆点
- 输入框提示"AI正在回复..."
- 输入框和发送按钮禁用

### 交互优化
- 自动滚动到底部
- 平滑动画效果
- 间隔2秒显示AI消息（模拟真实打字）

---

## 🔧 代码结构

### 拆分设计
```
src/utils/
├── groupMessageParser.ts  # 消息格式解析
├── groupChatApi.ts        # AI调用逻辑
└── groupChatManager.ts    # 群聊数据管理

src/pages/
└── GroupChatDetail.tsx    # 群聊详情页面
```

### 职责分离
- **Parser**：只负责解析AI返回的数据
- **API**：只负责构建提示词和调用AI
- **Manager**：只负责数据存储和读取
- **Page**：负责UI展示和用户交互

---

## 📊 数据流

```
用户发送消息
    ↓
保存到 groupChatManager
    ↓
触发 generateGroupChatReply
    ↓
构建提示词 (buildGroupChatPrompt)
    ↓
调用AI (callAIApi)
    ↓
解析响应 (extractGroupChatScript)
    ↓
逐条显示AI消息
    ↓
保存到 groupChatManager
```

---

## 🚀 后续可扩展功能

### 高优先级
- [ ] @功能（提及特定成员）
- [ ] 撤回消息（`[撤回了一条消息]`）
- [ ] 引用回复（`@某人 内容`）
- [ ] 私聊功能（`[私聊:内容]`）

### 中优先级
- [ ] 群公告显示
- [ ] 群成员列表侧边栏
- [ ] 群设置页面
- [ ] 退群功能（极端情况）

### 低优先级
- [ ] 群聊红包
- [ ] 群文件共享
- [ ] 群相册
- [ ] 群投票

---

## 💡 使用说明

### 创建群聊
1. 在通讯录点击"群聊"
2. 选择至少2个AI角色
3. 设置群名称
4. 完成创建

### 群聊对话
1. 进入群聊详情页
2. 输入消息并发送
3. AI会根据导演剧本模式生成回复
4. 2-4倍于成员数的消息量
5. 每条消息间隔2秒显示

---

## ⚠️ 注意事项

1. **API调用**：每次用户发送消息都会调用一次API
2. **响应时间**：AI生成剧本需要几秒钟，请耐心等待
3. **消息数量**：AI会生成多条消息，符合真实群聊体验
4. **成员匹配**：AI回复的成员名必须与群聊成员匹配

---

## 🎉 总结

✅ **已实现**：
- 群聊AI回复基础功能
- 导演剧本模式提示词
- 消息格式解析
- UI交互优化

✅ **代码特点**：
- 模块化设计
- 职责清晰
- 易于维护
- 方便扩展

现在可以在群聊中与多个AI角色自然对话了！🎊
