# 朋友圈AI系统 - 架构说明

## 📁 文件结构

```
momentsAI/
├── README.md              # 架构说明（本文件）
├── index.ts               # 导出入口
├── director.ts            # 主控制器（协调所有模块）
├── dataCollector.ts       # 数据收集器（聊天记录、朋友圈历史）
├── promptTemplate.ts      # 提示词模板
├── responseParser.ts      # 响应解析器（文本格式→结构化数据）
└── actionExecutor.ts      # 动作执行器（点赞、评论、私聊）

../types/momentsAI.ts      # 类型定义
../momentsAI.ts            # 主入口（保持向后兼容）
```

## 🎯 设计原则

### 1. **单一职责**
每个模块只负责一个功能，便于测试和维护

### 2. **高内聚低耦合**
模块之间通过明确的接口通信，减少依赖

### 3. **可拓展性**
新增动作类型只需修改 `actionExecutor.ts` 和 `responseParser.ts`

### 4. **可维护性**
代码结构清晰，注释完善，便于后续开发

## 📋 模块说明

### 1. dataCollector.ts
**职责**：收集数据供AI分析
- `getRecentChatHistory()` - 获取聊天记录
- `formatChatContext()` - 格式化聊天上下文
- `collectCharactersInfo()` - 收集所有角色信息
- `formatMomentsHistory()` - 格式化朋友圈历史

### 2. promptTemplate.ts
**职责**：管理AI提示词
- `buildDirectorPrompt()` - 构建导演提示词
- `SYSTEM_PROMPT` - 系统提示词常量

### 3. responseParser.ts
**职责**：解析AI响应
- `parseDirectorResponse()` - 解析文本格式响应
- `parseActionLine()` - 解析单行动作

### 4. actionExecutor.ts
**职责**：执行AI编排的动作
- `executeLikeAction()` - 执行点赞
- `executeCommentAction()` - 执行评论
- `executeDMAction()` - 执行私聊

### 5. director.ts
**职责**：主控制器，协调所有模块
- `aiDirectorArrangeScene()` - AI导演编排场景
- `triggerAIMomentsInteraction()` - 触发朋友圈互动
- `executeAction()` - 执行单个动作（内部函数）

## 🔄 工作流程

```
用户发布朋友圈
  ↓
triggerAIMomentsInteraction()
  ↓
dataCollector 收集数据
  ├─ 聊天记录
  ├─ 角色信息
  └─ 朋友圈历史
  ↓
promptTemplate 构建提示词
  ↓
director 调用API获取响应
  ↓
responseParser 解析响应
  ├─ 场景描述
  └─ 动作列表
  ↓
actionExecutor 执行每个动作
  ├─ 点赞 → 朋友圈
  ├─ 评论 → 朋友圈
  └─ 私聊 → 聊天窗口
```

## 🚀 如何拓展

### 添加新的动作类型

1. **更新类型定义** (`types/momentsAI.ts`)
```typescript
export type AIActionType = 'like' | 'comment' | 'dm' | 'share' | 'none'
```

2. **添加执行器** (`actionExecutor.ts`)
```typescript
export function executeShareAction(action: AIAction, moment: Moment, character: any): void {
  // 实现分享逻辑
}
```

3. **更新解析器** (`responseParser.ts`)
```typescript
const actionMap = {
  '点赞': 'like',
  '评论': 'comment',
  '私聊': 'dm',
  '转发': 'share',  // 新增
  '沉默': 'none'
}
```

4. **更新提示词** (`promptTemplate.ts`)
```typescript
说明：
- 转发格式：转发|角色ID|角色名|延迟秒数||
```

5. **更新控制器** (`director.ts`)
```typescript
switch (action.action) {
  case 'share':
    executeShareAction(action, moment, character)
    break
}
```

## ✨ 优势

1. **易于测试** - 每个模块可以独立测试
2. **易于维护** - 代码结构清晰，职责明确
3. **易于拓展** - 添加新功能不影响现有代码
4. **易于调试** - 每个模块有详细的日志输出
5. **向后兼容** - 保持原有的导出接口

## 📝 注意事项

1. 所有模块都使用 ES6+ 语法
2. 类型定义使用 TypeScript
3. 日志使用 console 输出，便于调试
4. 错误处理统一使用 try-catch
5. 异步操作使用 async/await

## 📊 控制台日志查看

打开浏览器控制台（F12），发布朋友圈后可以看到：

### 1. 导演输入阶段
```
================================================================================
🎬 AI导演编排场景 - 完整输入
================================================================================
# 你是一个专业的编剧导演...
（完整的提示词，包括角色信息、朋友圈内容、聊天记录等）
================================================================================

📤 发送给AI的完整请求:
System Prompt: ...
Temperature: 1.2
Max Tokens: 1000
```

### 2. 导演响应阶段
```
================================================================================
💬 AI导演的完整响应
================================================================================
场景:傲娇互动
点赞|汁汁|汁汁|5||
评论|汁汁|汁汁|10|哈？大白天发什么神经🙄|
...
================================================================================
```

### 3. 场景编排结果
```
✨✨✨✨✨✨✨✨✨✨✨✨✨✨✨✨✨✨✨✨✨✨✨✨✨✨✨✨✨✨✨✨✨✨✨✨✨✨✨✨
✨ 场景编排结果
✨✨✨✨✨✨✨✨✨✨✨✨✨✨✨✨✨✨✨✨✨✨✨✨✨✨✨✨✨✨✨✨✨✨✨✨✨✨✨✨
🎬 场景: 傲娇互动
📖 戏剧分析: ...
📋 共编排了 5 个动作
✨✨✨✨✨✨✨✨✨✨✨✨✨✨✨✨✨✨✨✨✨✨✨✨✨✨✨✨✨✨✨✨✨✨✨✨✨✨✨✨
```

### 4. 动作时间表
```
📅 动作时间表:

1. ⏱️ 汁汁 - 5秒后点赞
   📝 理由: 点赞

2. ⏱️ 汁汁 - 10秒后评论
   📝 理由: 评论
   💬 评论: 哈？大白天发什么神经🙄

3. ⏱️ 汁汁 - 12秒后私聊
   📝 理由: 私聊
   📱 私聊: 喂，到底怎么了？
```

### 5. 动作执行
```
▶️▶️▶️▶️▶️▶️▶️▶️▶️▶️▶️▶️▶️▶️▶️▶️▶️▶️▶️▶️
▶️  执行动作: 汁汁 点赞
▶️▶️▶️▶️▶️▶️▶️▶️▶️▶️▶️▶️▶️▶️▶️▶️▶️▶️▶️▶️
👍 汁汁 点赞了！
```

## 🎯 提示词设计哲学

### 核心理念：引导思考，不给模板

参考MoM果实等优秀预设的设计，我们的提示词：

1. **给原则，不给示例**
   - ✅ "关系越亲密，互动越主动"
   - ❌ "女友评论'宝贝辛苦了❤️'"

2. **用正反案例说明，不用完整场景**
   - ✅ "看到陌生评论 → 质疑'你谁啊？'"
   - ❌ "场景1：女友A在0秒评论...场景2：暧昧对象B在5秒..."

3. **强调禁忌，防止套路化**
   - 🚫 禁止模板化
   - 🚫 禁止套路化冲突
   - 🚫 禁止角色失忆
   - 🚫 禁止忽视朋友圈内容

4. **突出核心约束**
   - 角色视角是底线
   - 真实性优先于戏剧性
   - 每次编排都要创新

### 为什么这样设计？

**问题**：如果给3个完整场景示例，AI会：
- 机械模仿示例中的台词
- 翻来覆去就那几个样子
- 缺乏创造力

**解决**：给原则和禁忌，AI会：
- 理解"什么该做"、"什么不该做"
- 根据朋友圈内容创造新反应
- 保持多样性和真实性

## 🔧 未来改进

1. 添加缓存机制减少API调用
2. 支持批量编排多个场景
3. 添加场景记录和回放功能
4. 支持自定义提示词模板
5. 添加单元测试和集成测试
