<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è®°å¿†æ€»ç»“APIæµ‹è¯•</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .card {
      background: white;
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    h1 {
      color: #333;
      margin-top: 0;
    }
    h2 {
      color: #666;
      font-size: 18px;
      margin-top: 0;
    }
    button {
      background: #000;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      margin-right: 10px;
      margin-bottom: 10px;
    }
    button:hover {
      background: #333;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .status {
      padding: 12px;
      border-radius: 8px;
      margin-top: 12px;
      font-family: monospace;
      font-size: 13px;
      line-height: 1.6;
    }
    .status.success {
      background: #d4edda;
      color: #155724;
    }
    .status.error {
      background: #f8d7da;
      color: #721c24;
    }
    .status.info {
      background: #d1ecf1;
      color: #0c5460;
    }
    .status.warning {
      background: #fff3cd;
      color: #856404;
    }
    .log {
      background: #1e1e1e;
      color: #d4d4d4;
      padding: 16px;
      border-radius: 8px;
      max-height: 400px;
      overflow-y: auto;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      line-height: 1.5;
    }
    .log div {
      margin-bottom: 4px;
    }
  </style>
</head>
<body>
  <div class="card">
    <h1>ğŸ§ª è®°å¿†æ€»ç»“APIæµ‹è¯•å·¥å…·</h1>
    <p>ç”¨äºè¯Šæ–­"æ€»ç»“ä¸€ç›´åœ¨æ€»ç»“ä¸­"çš„é—®é¢˜</p>
  </div>

  <div class="card">
    <h2>1. æ£€æŸ¥APIé…ç½®</h2>
    <button onclick="checkApiConfig()">æ£€æŸ¥é…ç½®</button>
    <div id="configStatus"></div>
  </div>

  <div class="card">
    <h2>2. æµ‹è¯•APIè¿æ¥</h2>
    <button onclick="testApiConnection()">æµ‹è¯•ä¸»API</button>
    <button onclick="testSubApiConnection()">æµ‹è¯•å‰¯API</button>
    <div id="connectionStatus"></div>
  </div>

  <div class="card">
    <h2>3. æ¨¡æ‹Ÿè®°å¿†æ€»ç»“</h2>
    <button onclick="simulateSummary()">æ¨¡æ‹Ÿæ€»ç»“ï¼ˆå¿«é€Ÿæµ‹è¯•ï¼‰</button>
    <div id="summaryStatus"></div>
  </div>

  <div class="card">
    <h2>4. å®æ—¶æ—¥å¿—</h2>
    <button onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
    <div id="log" class="log"></div>
  </div>

  <script>
    const logDiv = document.getElementById('log')
    
    function addLog(message, type = 'info') {
      const div = document.createElement('div')
      const emoji = {
        info: 'â„¹ï¸',
        success: 'âœ…',
        error: 'âŒ',
        warning: 'âš ï¸'
      }[type] || 'â„¹ï¸'
      
      div.textContent = `[${new Date().toLocaleTimeString()}] ${emoji} ${message}`
      logDiv.appendChild(div)
      logDiv.scrollTop = logDiv.scrollHeight
    }

    function clearLog() {
      logDiv.innerHTML = ''
      addLog('æ—¥å¿—å·²æ¸…ç©º')
    }

    function checkApiConfig() {
      addLog('å¼€å§‹æ£€æŸ¥APIé…ç½®...')
      const statusDiv = document.getElementById('configStatus')
      statusDiv.innerHTML = ''
      
      try {
        // æ£€æŸ¥ä¸»API
        const mainApi = localStorage.getItem('api_settings')
        let mainApiConfig = null
        if (mainApi) {
          mainApiConfig = JSON.parse(mainApi)
          addLog('ä¸»APIé…ç½®å­˜åœ¨', 'success')
          addLog(`  baseUrl: ${mainApiConfig.baseUrl}`)
          addLog(`  model: ${mainApiConfig.model}`)
          addLog(`  apiKey: ${mainApiConfig.apiKey ? 'å·²è®¾ç½® (' + mainApiConfig.apiKey.substring(0, 8) + '...)' : 'æœªè®¾ç½®'}`, mainApiConfig.apiKey ? 'success' : 'error')
        } else {
          addLog('ä¸»APIæœªé…ç½®', 'error')
        }
        
        // æ£€æŸ¥å‰¯API
        const subApi = localStorage.getItem('SUB_API_SETTINGS')
        let subApiConfig = null
        if (subApi) {
          subApiConfig = JSON.parse(subApi)
          addLog('å‰¯APIé…ç½®å­˜åœ¨', 'success')
          addLog(`  baseUrl: ${subApiConfig.baseUrl}`)
          addLog(`  model: ${subApiConfig.model}`)
          addLog(`  apiKey: ${subApiConfig.apiKey ? 'å·²è®¾ç½® (' + subApiConfig.apiKey.substring(0, 8) + '...)' : 'æœªè®¾ç½®'}`, subApiConfig.apiKey ? 'success' : 'error')
        } else {
          addLog('å‰¯APIæœªé…ç½®ï¼ˆå¯é€‰ï¼‰', 'warning')
        }
        
        // æ˜¾ç¤ºçŠ¶æ€
        let html = ''
        if (mainApiConfig) {
          html += `<div class="status success">
            âœ… ä¸»APIå·²é…ç½®<br>
            æ¨¡å‹: ${mainApiConfig.model}<br>
            åœ°å€: ${mainApiConfig.baseUrl}
          </div>`
        } else {
          html += `<div class="status error">
            âŒ ä¸»APIæœªé…ç½®<br>
            è¯·å‰å¾€ç³»ç»Ÿè®¾ç½® â†’ APIé…ç½® è¿›è¡Œè®¾ç½®
          </div>`
        }
        
        if (subApiConfig) {
          html += `<div class="status success">
            âœ… å‰¯APIå·²é…ç½®<br>
            æ¨¡å‹: ${subApiConfig.model}<br>
            åœ°å€: ${subApiConfig.baseUrl}
          </div>`
        } else {
          html += `<div class="status info">
            â„¹ï¸ å‰¯APIæœªé…ç½®ï¼ˆæ¨èé…ç½®ä»¥æé«˜æ€»ç»“é€Ÿåº¦ï¼‰
          </div>`
        }
        
        statusDiv.innerHTML = html
        addLog('é…ç½®æ£€æŸ¥å®Œæˆ')
        
      } catch (error) {
        addLog('æ£€æŸ¥é…ç½®æ—¶å‡ºé”™: ' + error.message, 'error')
        statusDiv.innerHTML = `<div class="status error">âŒ é”™è¯¯: ${error.message}</div>`
      }
    }

    async function testApiConnection() {
      addLog('å¼€å§‹æµ‹è¯•ä¸»APIè¿æ¥...')
      const statusDiv = document.getElementById('connectionStatus')
      statusDiv.innerHTML = '<div class="status info">æµ‹è¯•ä¸­...</div>'
      
      try {
        const apiSettings = localStorage.getItem('api_settings')
        if (!apiSettings) {
          throw new Error('ä¸»APIæœªé…ç½®')
        }
        
        const api = JSON.parse(apiSettings)
        addLog(`æ­£åœ¨è¿æ¥: ${api.baseUrl}`)
        
        const testMessage = [
          { role: 'user', content: 'ä½ å¥½ï¼Œè¿™æ˜¯ä¸€ä¸ªæµ‹è¯•æ¶ˆæ¯ï¼Œè¯·ç®€å•å›å¤"æµ‹è¯•æˆåŠŸ"' }
        ]
        
        const response = await fetch(`${api.baseUrl}/v1/chat/completions`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${api.apiKey}`
          },
          body: JSON.stringify({
            model: api.model,
            messages: testMessage,
            max_tokens: 50
          })
        })
        
        if (!response.ok) {
          const error = await response.text()
          throw new Error(`HTTP ${response.status}: ${error}`)
        }
        
        const data = await response.json()
        const reply = data.choices[0].message.content
        
        addLog('ä¸»APIè¿æ¥æˆåŠŸ', 'success')
        addLog(`APIå›å¤: ${reply}`)
        statusDiv.innerHTML = `<div class="status success">
          âœ… ä¸»APIè¿æ¥æˆåŠŸ<br>
          å›å¤: ${reply}
        </div>`
        
      } catch (error) {
        addLog('ä¸»APIè¿æ¥å¤±è´¥: ' + error.message, 'error')
        statusDiv.innerHTML = `<div class="status error">
          âŒ è¿æ¥å¤±è´¥<br>
          é”™è¯¯: ${error.message}
        </div>`
      }
    }

    async function testSubApiConnection() {
      addLog('å¼€å§‹æµ‹è¯•å‰¯APIè¿æ¥...')
      const statusDiv = document.getElementById('connectionStatus')
      statusDiv.innerHTML = '<div class="status info">æµ‹è¯•ä¸­...</div>'
      
      try {
        const apiSettings = localStorage.getItem('SUB_API_SETTINGS')
        if (!apiSettings) {
          throw new Error('å‰¯APIæœªé…ç½®')
        }
        
        const api = JSON.parse(apiSettings)
        addLog(`æ­£åœ¨è¿æ¥: ${api.baseUrl}`)
        
        const testMessage = [
          { role: 'user', content: 'ä½ å¥½ï¼Œè¿™æ˜¯ä¸€ä¸ªæµ‹è¯•æ¶ˆæ¯ï¼Œè¯·ç®€å•å›å¤"æµ‹è¯•æˆåŠŸ"' }
        ]
        
        const response = await fetch(`${api.baseUrl}/v1/chat/completions`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${api.apiKey}`
          },
          body: JSON.stringify({
            model: api.model,
            messages: testMessage,
            max_tokens: 50
          })
        })
        
        if (!response.ok) {
          const error = await response.text()
          throw new Error(`HTTP ${response.status}: ${error}`)
        }
        
        const data = await response.json()
        const reply = data.choices[0].message.content
        
        addLog('å‰¯APIè¿æ¥æˆåŠŸ', 'success')
        addLog(`APIå›å¤: ${reply}`)
        statusDiv.innerHTML = `<div class="status success">
          âœ… å‰¯APIè¿æ¥æˆåŠŸ<br>
          å›å¤: ${reply}
        </div>`
        
      } catch (error) {
        addLog('å‰¯APIè¿æ¥å¤±è´¥: ' + error.message, 'error')
        statusDiv.innerHTML = `<div class="status error">
          âŒ è¿æ¥å¤±è´¥<br>
          é”™è¯¯: ${error.message}
        </div>`
      }
    }

    async function simulateSummary() {
      addLog('å¼€å§‹æ¨¡æ‹Ÿè®°å¿†æ€»ç»“æµç¨‹...')
      const statusDiv = document.getElementById('summaryStatus')
      statusDiv.innerHTML = '<div class="status info">æ­£åœ¨æ€»ç»“...</div>'
      
      const testMessages = [
        { type: 'sent', content: 'ä½ å¥½ï¼Œä»Šå¤©å¤©æ°”çœŸä¸é”™' },
        { type: 'received', content: 'æ˜¯å•Šï¼Œé˜³å…‰æ˜åªšï¼Œå¾ˆé€‚åˆå‡ºå»èµ°èµ°' },
        { type: 'sent', content: 'è¦ä¸è¦ä¸€èµ·å»å…¬å›­ï¼Ÿ' },
        { type: 'received', content: 'å¥½å•Šï¼Œæˆ‘æ­£æƒ³å‡ºå»æ”¾æ¾ä¸€ä¸‹å‘¢' }
      ]
      
      try {
        addLog(`æ¶ˆæ¯æ•°é‡: ${testMessages.length}`)
        
        const conversationText = testMessages.map(m => {
          const sender = m.type === 'sent' ? 'ç”¨æˆ·' : 'è§’è‰²'
          return `${sender}: ${m.content}`
        }).join('\n')
        
        addLog('å¯¹è¯æ–‡æœ¬:')
        addLog(conversationText)
        
        // é€‰æ‹©API
        let apiConfig = null
        let apiType = ''
        
        const subApi = localStorage.getItem('SUB_API_SETTINGS')
        if (subApi) {
          apiConfig = JSON.parse(subApi)
          apiType = 'å‰¯API'
          addLog('ä½¿ç”¨å‰¯APIè¿›è¡Œæ€»ç»“', 'success')
        } else {
          const mainApi = localStorage.getItem('api_settings')
          if (mainApi) {
            apiConfig = JSON.parse(mainApi)
            apiType = 'ä¸»API'
            addLog('ä½¿ç”¨ä¸»APIè¿›è¡Œæ€»ç»“', 'warning')
          }
        }
        
        if (!apiConfig) {
          throw new Error('æœªé…ç½®API')
        }
        
        addLog(`è°ƒç”¨${apiType}: ${apiConfig.baseUrl}`)
        addLog(`æ¨¡å‹: ${apiConfig.model}`)
        
        const prompt = `è¯·ä¸ºä»¥ä¸‹å†…å®¹ç”Ÿæˆä¸€ä¸ªç®€æ´çš„æ€»ç»“ï¼ˆä¸è¶…è¿‡200å­—ï¼‰ï¼š

${conversationText}

è¦æ±‚ï¼š
1. æå–å…³é”®ä¿¡æ¯å’Œä¸»è¦äº‹ä»¶
2. ä¿æŒå®¢è§‚å‡†ç¡®
3. è¯­è¨€ç²¾ç‚¼`

        const response = await fetch(`${apiConfig.baseUrl}/v1/chat/completions`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${apiConfig.apiKey}`
          },
          body: JSON.stringify({
            model: apiConfig.model,
            messages: [{ role: 'user', content: prompt }],
            max_tokens: 400,
            temperature: 0.5
          })
        })
        
        if (!response.ok) {
          const error = await response.text()
          throw new Error(`HTTP ${response.status}: ${error}`)
        }
        
        const data = await response.json()
        const summary = data.choices[0].message.content
        
        addLog('æ€»ç»“ç”ŸæˆæˆåŠŸ', 'success')
        addLog(`æ€»ç»“å†…å®¹: ${summary}`)
        
        statusDiv.innerHTML = `<div class="status success">
          âœ… æ€»ç»“æˆåŠŸ<br><br>
          <strong>æ€»ç»“å†…å®¹ï¼š</strong><br>
          ${summary}
        </div>`
        
      } catch (error) {
        addLog('æ€»ç»“å¤±è´¥: ' + error.message, 'error')
        
        const fallbackSummary = `è¿™æ®µå¯¹è¯åŒ…å« ${testMessages.length} æ¡æ¶ˆæ¯ï¼ˆç”¨æˆ· 2 æ¡ï¼Œè§’è‰² 2 æ¡ï¼‰`
        addLog('ä½¿ç”¨å¤‡ç”¨æ€»ç»“: ' + fallbackSummary, 'warning')
        
        statusDiv.innerHTML = `<div class="status error">
          âŒ AIæ€»ç»“å¤±è´¥<br>
          é”™è¯¯: ${error.message}<br><br>
          <div class="status warning">
            ä½¿ç”¨å¤‡ç”¨æ€»ç»“ï¼š<br>
            ${fallbackSummary}
          </div>
        </div>`
      }
    }

    // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥é…ç½®
    window.addEventListener('load', () => {
      addLog('æµ‹è¯•å·¥å…·å·²åŠ è½½')
      addLog('å»ºè®®å…ˆç‚¹å‡»"æ£€æŸ¥é…ç½®"æŒ‰é’®')
    })
  </script>
</body>
</html>
