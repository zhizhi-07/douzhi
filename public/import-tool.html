<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è±†æ±æ•°æ®å¯¼å…¥å·¥å…·</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .container {
      background: white;
      border-radius: 20px;
      padding: 40px;
      max-width: 500px;
      width: 100%;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    h1 {
      text-align: center;
      color: #333;
      margin-bottom: 10px;
    }
    .subtitle {
      text-align: center;
      color: #666;
      margin-bottom: 30px;
      font-size: 14px;
    }
    .step {
      background: #f8f9fa;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 15px;
    }
    .step-title {
      font-weight: bold;
      color: #333;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .step-num {
      background: #667eea;
      color: white;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
    }
    button {
      width: 100%;
      padding: 15px;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.3s;
      margin-top: 10px;
    }
    .btn-danger {
      background: #dc3545;
      color: white;
    }
    .btn-danger:hover {
      background: #c82333;
    }
    .btn-primary {
      background: #667eea;
      color: white;
    }
    .btn-primary:hover {
      background: #5a6fd6;
    }
    .btn-success {
      background: #28a745;
      color: white;
    }
    .btn-success:hover {
      background: #218838;
    }
    #progress {
      display: none;
      margin-top: 20px;
    }
    .progress-bar {
      background: #e9ecef;
      border-radius: 10px;
      height: 20px;
      overflow: hidden;
    }
    .progress-fill {
      background: linear-gradient(90deg, #667eea, #764ba2);
      height: 100%;
      width: 0%;
      transition: width 0.3s;
    }
    .progress-text {
      text-align: center;
      margin-top: 10px;
      color: #666;
    }
    #log {
      background: #1e1e1e;
      color: #0f0;
      font-family: monospace;
      font-size: 12px;
      padding: 15px;
      border-radius: 10px;
      max-height: 200px;
      overflow-y: auto;
      margin-top: 20px;
      display: none;
    }
    .log-error { color: #ff6b6b; }
    .log-success { color: #51cf66; }
    .log-info { color: #74c0fc; }
    .warning {
      background: #fff3cd;
      border: 1px solid #ffc107;
      border-radius: 8px;
      padding: 10px;
      margin-bottom: 20px;
      font-size: 13px;
      color: #856404;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ«˜ è±†æ±æ•°æ®å¯¼å…¥å·¥å…·</h1>
    <p class="subtitle">ç‹¬ç«‹å·¥å…·ï¼Œé¿å…åº”ç”¨å†²çª</p>
    
    <div class="warning">
      âš ï¸ è¯·å…ˆå…³é—­è±†æ±åº”ç”¨çš„æ‰€æœ‰æ ‡ç­¾é¡µï¼Œåªä¿ç•™è¿™ä¸ªé¡µé¢ï¼
    </div>

    <div class="step">
      <div class="step-title">
        <span class="step-num">1</span>
        æ¸…ç©ºæ‰€æœ‰æ—§æ•°æ®
      </div>
      <button class="btn-danger" onclick="clearAllData()">ğŸ—‘ï¸ æ¸…ç©ºæ•°æ®åº“</button>
    </div>

    <div class="step">
      <div class="step-title">
        <span class="step-num">2</span>
        é€‰æ‹©å¤‡ä»½æ–‡ä»¶å¯¼å…¥
      </div>
      <input type="file" id="fileInput" accept=".json,.å¤‡ä»½" style="display:none" onchange="handleFile(this)">
      <button class="btn-primary" onclick="document.getElementById('fileInput').click()">ğŸ“ é€‰æ‹©å¤‡ä»½æ–‡ä»¶</button>
    </div>

    <div class="step">
      <div class="step-title">
        <span class="step-num">3</span>
        è¿”å›åº”ç”¨
      </div>
      <button class="btn-success" onclick="goBack()">ğŸš€ è¿”å›è±†æ±åº”ç”¨</button>
    </div>

    <div id="progress">
      <div class="progress-bar">
        <div class="progress-fill" id="progressFill"></div>
      </div>
      <div class="progress-text" id="progressText">å‡†å¤‡ä¸­...</div>
    </div>

    <div id="log"></div>
  </div>

  <script>
    const DB_NAMES = [
      'DouzhiDB', 'EmojiDB', 'AILocationDB', 'forum_db', 
      'forum-comments-db', 'topic_chat_db', 'douzhi_device',
      'AvatarDB', 'IconDB', 'WallpaperDB', 'BubbleStyleDB', 'FontDB',
      'UnifiedMemoryDB', 'CouplePhotosDB', 'AppStorage', 'AvatarStorage',
      'BackgroundStorage', 'IconStorage', 'FontStorage', 'kiro_avatar_library'
    ];

    function log(msg, type = 'info') {
      const logEl = document.getElementById('log');
      logEl.style.display = 'block';
      const line = document.createElement('div');
      line.className = 'log-' + type;
      line.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
      logEl.appendChild(line);
      logEl.scrollTop = logEl.scrollHeight;
    }

    function setProgress(percent, text) {
      document.getElementById('progress').style.display = 'block';
      document.getElementById('progressFill').style.width = percent + '%';
      document.getElementById('progressText').textContent = text;
    }

    // ğŸ”¥ ä¿å­˜çš„ç”¨æˆ·ä¿¡æ¯ï¼ˆæ¸…ç©ºå‰å¤‡ä»½ï¼‰
    let savedUserInfo = null;
    let savedApiConfig = null;

    async function clearAllData() {
      if (!confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ•°æ®å—ï¼Ÿè¿™å°†åˆ é™¤æ‰€æœ‰è§’è‰²å’ŒèŠå¤©è®°å½•ï¼\n\nï¼ˆç™»å½•ä¿¡æ¯ä¼šä¿ç•™ï¼‰')) return;
      
      log('å¼€å§‹æ¸…ç©ºæ•°æ®...', 'info');
      setProgress(0, 'æ¸…ç©ºä¸­...');
      
      // ğŸ”¥ å…ˆä¿å­˜ç”¨æˆ·ç™»å½•ä¿¡æ¯
      savedUserInfo = localStorage.getItem('user_info');
      savedApiConfig = localStorage.getItem('api_config');
      if (savedUserInfo) {
        log('ğŸ’¾ å·²ä¿å­˜ç”¨æˆ·ç™»å½•ä¿¡æ¯', 'info');
      }
      
      // æ¸…ç©º localStorage
      localStorage.clear();
      log('âœ… localStorage å·²æ¸…ç©º', 'success');
      
      // ğŸ”¥ æ¢å¤ç”¨æˆ·ç™»å½•ä¿¡æ¯
      if (savedUserInfo) {
        localStorage.setItem('user_info', savedUserInfo);
        log('âœ… å·²æ¢å¤ç”¨æˆ·ç™»å½•ä¿¡æ¯', 'success');
      }
      if (savedApiConfig) {
        localStorage.setItem('api_config', savedApiConfig);
        log('âœ… å·²æ¢å¤ API é…ç½®', 'success');
      }
      
      // åˆ é™¤æ‰€æœ‰ IndexedDB
      let deleted = 0;
      for (const dbName of DB_NAMES) {
        try {
          await new Promise((resolve) => {
            const req = indexedDB.deleteDatabase(dbName);
            req.onsuccess = () => {
              log(`âœ… å·²åˆ é™¤: ${dbName}`, 'success');
              resolve();
            };
            req.onerror = () => {
              log(`âš ï¸ åˆ é™¤å¤±è´¥: ${dbName}`, 'error');
              resolve();
            };
            req.onblocked = () => {
              log(`âš ï¸ è¢«é˜»å¡: ${dbName}`, 'error');
              resolve();
            };
            setTimeout(resolve, 3000);
          });
          deleted++;
          setProgress((deleted / DB_NAMES.length) * 100, `å·²åˆ é™¤ ${deleted}/${DB_NAMES.length}`);
        } catch (e) {
          log(`âŒ é”™è¯¯: ${dbName} - ${e.message}`, 'error');
        }
      }
      
      setProgress(100, 'æ¸…ç©ºå®Œæˆï¼');
      log('ğŸ‰ æ‰€æœ‰æ•°æ®å·²æ¸…ç©ºï¼', 'success');
      alert('âœ… æ•°æ®å·²æ¸…ç©ºï¼ç°åœ¨å¯ä»¥å¯¼å…¥å¤‡ä»½æ–‡ä»¶äº†ã€‚');
    }

    async function handleFile(input) {
      const file = input.files[0];
      if (!file) return;
      
      log(`ğŸ“ è¯»å–æ–‡ä»¶: ${file.name} (${(file.size/1024/1024).toFixed(2)} MB)`, 'info');
      setProgress(5, 'è¯»å–æ–‡ä»¶...');
      
      try {
        const text = await file.text();
        setProgress(20, 'è§£ææ•°æ®...');
        log('ğŸ“ è§£æ JSON...', 'info');
        
        const data = JSON.parse(text);
        log(`âœ… è§£ææˆåŠŸ: ç‰ˆæœ¬ ${data.version || 'æœªçŸ¥'}`, 'success');
        
        // å¯¼å…¥ localStorage
        if (data.localStorage) {
          setProgress(30, 'å¯¼å…¥ localStorage...');
          let count = 0;
          for (const key in data.localStorage) {
            try {
              localStorage.setItem(key, data.localStorage[key]);
              count++;
            } catch (e) {
              // è·³è¿‡å¤ªå¤§çš„é¡¹
            }
          }
          log(`âœ… localStorage: ${count} é¡¹`, 'success');
        }
        
        // å¯¼å…¥ IndexedDB
        if (data.indexedDB) {
          const dbNames = Object.keys(data.indexedDB);
          log(`ğŸ“¦ å¼€å§‹å¯¼å…¥ ${dbNames.length} ä¸ªæ•°æ®åº“...`, 'info');
          
          for (let i = 0; i < dbNames.length; i++) {
            const dbName = dbNames[i];
            const dbData = data.indexedDB[dbName];
            
            setProgress(30 + (i / dbNames.length) * 60, `å¯¼å…¥ ${dbName}...`);
            
            try {
              await importDatabase(dbName, dbData);
              log(`âœ… ${dbName} å¯¼å…¥æˆåŠŸ`, 'success');
            } catch (e) {
              log(`âŒ ${dbName} å¯¼å…¥å¤±è´¥: ${e.message}`, 'error');
            }
          }
        }
        
        setProgress(100, 'å¯¼å…¥å®Œæˆï¼');
        log('ğŸ‰ æ‰€æœ‰æ•°æ®å¯¼å…¥å®Œæˆï¼', 'success');
        alert('âœ… å¯¼å…¥æˆåŠŸï¼ç‚¹å‡»"è¿”å›è±†æ±åº”ç”¨"æŒ‰é’®ç»§ç»­ã€‚');
        
      } catch (e) {
        log(`âŒ å¯¼å…¥å¤±è´¥: ${e.message}`, 'error');
        alert('âŒ å¯¼å…¥å¤±è´¥: ' + e.message);
        setProgress(0, 'å¤±è´¥');
      }
    }

    // ğŸ”¥ DouzhiDB éœ€è¦çš„æ‰€æœ‰ stores
    const DOUZHI_STORES = [
      'messages', 'moments', 'characters', 'userInfo', 
      'wallet', 'emojis', 'settings', 'misc',
      'dmMessages', 'dmConversations'
    ];

    async function importDatabase(dbName, data) {
      // å…ˆåˆ é™¤æ—§æ•°æ®åº“
      await new Promise(resolve => {
        const req = indexedDB.deleteDatabase(dbName);
        req.onsuccess = resolve;
        req.onerror = resolve;
        req.onblocked = resolve;
        setTimeout(resolve, 2000);
      });
      
      return new Promise((resolve, reject) => {
        const storeNames = Object.keys(data);
        if (storeNames.length === 0) {
          resolve();
          return;
        }
        
        // ğŸ”¥ DouzhiDB ä½¿ç”¨ç‰ˆæœ¬ 4ï¼Œå…¶ä»–ä½¿ç”¨ 1
        const version = dbName === 'DouzhiDB' ? 4 : 1;
        const request = indexedDB.open(dbName, version);
        
        request.onerror = () => reject(request.error);
        
        request.onupgradeneeded = (e) => {
          const db = e.target.result;
          
          // ğŸ”¥ DouzhiDB éœ€è¦åˆ›å»ºæ‰€æœ‰é¢„å®šä¹‰çš„ stores
          if (dbName === 'DouzhiDB') {
            for (const storeName of DOUZHI_STORES) {
              if (!db.objectStoreNames.contains(storeName)) {
                db.createObjectStore(storeName);
                log(`  ğŸ“¦ åˆ›å»º store: ${storeName}`, 'info');
              }
            }
          }
          
          // åˆ›å»ºå¤‡ä»½æ•°æ®ä¸­çš„ stores
          for (const storeName of storeNames) {
            if (!db.objectStoreNames.contains(storeName)) {
              db.createObjectStore(storeName);
            }
          }
        };
        
        request.onsuccess = async (e) => {
          const db = e.target.result;
          
          try {
            for (const storeName of storeNames) {
              if (!db.objectStoreNames.contains(storeName)) continue;
              
              const storeData = data[storeName];
              if (!storeData) continue;
              
              // å¤„ç†æ–°æ ¼å¼ { keys, values }
              if (storeData.keys && storeData.values) {
                const tx = db.transaction(storeName, 'readwrite');
                const store = tx.objectStore(storeName);
                
                for (let i = 0; i < storeData.keys.length; i++) {
                  store.put(storeData.values[i], storeData.keys[i]);
                }
                
                await new Promise((res, rej) => {
                  tx.oncomplete = res;
                  tx.onerror = () => rej(tx.error);
                });
                
                log(`  ğŸ“ ${storeName}: ${storeData.keys.length} æ¡è®°å½•`, 'info');
                
                // ğŸ”¥ ç‰¹åˆ«æ˜¾ç¤ºè§’è‰²æ•°é‡
                if (storeName === 'characters' && storeData.values[0]) {
                  const chars = storeData.values[0];
                  if (Array.isArray(chars)) {
                    log(`  ğŸ‘¤ å‘ç° ${chars.length} ä¸ªè§’è‰²`, 'success');
                  }
                }
              } else {
                log(`  âš ï¸ ${storeName}: æ ¼å¼ä¸è¯†åˆ«`, 'error');
              }
            }
            
            db.close();
            resolve();
          } catch (e) {
            db.close();
            reject(e);
          }
        };
      });
    }

    function goBack() {
      window.location.href = '/';
    }
  </script>
</body>
</html>
