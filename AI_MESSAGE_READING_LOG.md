# AI 消息读取详细日志功能

## 问题描述

用户反馈："ai记性好差啊..我选了读500条真的读了吗？？把ai读的输出的全放控制台"

用户想要在控制台中看到AI实际读取了多少条消息，以及具体读取了哪些消息内容，以便确认AI是否真的按照设置读取了500条消息。

## 解决方案

### 修改文件1：`src/utils/messageUtils.ts`

在 `getRecentMessages` 函数中添加详细日志，显示消息读取的配置和实际情况。

**修改位置**：第355-358行

**添加的日志**：
```typescript
// 🔥 输出实际使用的消息条数限制
console.log(`📊 [消息读取] 设置的限制: ${limit === 0 ? '无限制(读取全部)' : limit + '条'}`)
console.log(`📊 [消息读取] 总消息数: ${messages.length}条`)
console.log(`📊 [消息读取] 将返回: ${limit === 0 ? messages.length : Math.min(limit, messages.length)}条`)
```

**日志内容说明**：
- **设置的限制**：显示用户在设置中配置的消息条数（0表示无限制）
- **总消息数**：显示localStorage中存储的总消息数
- **将返回**：显示实际会返回给AI的消息数（取限制和总数的较小值）

### 修改文件2：`src/pages/ChatDetail/hooks/useChatAI.ts`

在AI请求发送前，添加详细的消息列表日志。

**修改位置**：第382-412行

**添加的日志**：

#### 1. 统计信息
```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📖 [AI读取消息] 总消息数: XXX条
📖 [AI读取消息] 实际读取: XXX条 (根据设置)
📖 [AI读取消息] 转为API消息: XXX条
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

#### 2. 消息详情表格
使用 `console.table` 以表格形式展示每条消息：
- **序号**：消息的序号
- **角色**：用户/AI
- **时间**：消息发送时间（月/日 时:分）
- **内容预览**：消息内容的前50个字符
- **类型**：消息类型（text/emoji/photo等）

#### 3. API消息格式
显示转换后实际发送给AI的消息：
```
📤 [API消息格式] 发送给AI的消息列表:
  1. [user] 消息内容...
  2. [assistant] 消息内容...
  ...
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

#### 4. 系统提示词完整内容 🔥 NEW
显示AI读取的完整系统提示词（包含角色设定、记忆、朋友圈、世界书等）：
```
📝 [系统提示词] AI读取的完整提示词:
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
[这里是完整的系统提示词内容，包括：
- 角色人格设定
- 当前时间和场景
- 用户信息和关系
- 记忆和随笔
- 朋友圈动态
- 世界书条目
- 功能指令说明
等等...]
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📏 [提示词长度] XXXX 字符
📊 [统计信息] 消息条数: XXX, 用户拉黑AI: false, AI拉黑用户: false
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

## 使用方法

1. **打开浏览器控制台**：按 F12 或右键"检查"
2. **发送消息给AI**：在聊天界面中发送任意消息
3. **查看日志**：在控制台中会看到详细的日志输出

## 日志输出示例

```
📊 [消息读取] 设置的限制: 500条
📊 [消息读取] 总消息数: 482条
📊 [消息读取] 将返回: 482条

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📖 [AI读取消息] 总消息数: 482条
📖 [AI读取消息] 实际读取: 482条 (根据设置)
📖 [AI读取消息] 转为API消息: 482条
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

┌─────────┬──────┬────────┬──────────────┬──────────────────────────────────┬────────┐
│ (index) │ 序号 │  角色  │     时间     │            内容预览              │  类型  │
├─────────┼──────┼────────┼──────────────┼──────────────────────────────────┼────────┤
│    0    │  1   │ '用户' │ '11/21 09:30'│ '你好'                           │ 'text' │
│    1    │  2   │ 'AI'   │ '11/21 09:30'│ '你好啊！'                        │ 'text' │
│   ...   │ ...  │  ...   │     ...      │              ...                 │  ...   │
└─────────┴──────┴────────┴──────────────┴──────────────────────────────────┴────────┘

📤 [API消息格式] 发送给AI的消息列表:
  1. [user] 你好
  2. [assistant] 你好啊！
  ...
  482. [user] 今天天气怎么样？

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

📝 [系统提示词] AI读取的完整提示词:
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
你就是「方亦楷」，一个活生生的人，现在正拿着手机在和 用户 聊天。

你们现在【不在同一个空间】，只是各自在自己的环境里用手机聊天...

现在是：2025年11月21日，大概是 上午 的 10:25（10 点左右）...

[角色人格设定]
[记忆系统]
[朋友圈内容]
[世界书条目]
[功能指令说明]
...
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📏 [提示词长度] 15234 字符
📊 [统计信息] 消息条数: 482, 用户拉黑AI: false, AI拉黑用户: false
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

## 功能说明

### 1. AI接收的完整内容
AI实际接收的内容包括两部分：
- **系统提示词**（第一条消息，role: system）
- **历史对话**（后续消息，role: user/assistant）

#### 系统提示词包含：
- 🎭 **角色人格**：角色名字、性格、说话风格
- 📅 **时间场景**：当前日期、时间、场景模式（线上/线下）
- 👤 **用户信息**：用户昵称、人设、关系状态
- 🧠 **记忆系统**：长期记忆、随笔、重要事件
- 📱 **朋友圈**：最近的朋友圈动态
- 📚 **世界书**：相关的世界书条目
- ⚡ **功能指令**：[表情]、[转账]、[外卖]等功能说明
- 💡 **智能提醒**：外卖提醒、随笔提醒等

### 2. 消息读取流程
1. 从 localStorage 读取所有消息（`currentMessages`）
2. 根据用户设置的消息条数限制截取最近的消息（`recentMessages`）
3. 将消息转换为API格式（`apiMessages`）
4. 构建系统提示词（`systemPrompt`）
5. 合并发送：`[{role: 'system', content: systemPrompt}, ...apiMessages]`

### 3. 消息条数设置位置
- 进入聊天设置页面
- 找到"消息条数"设置
- 可选：50条、200条、500条，或自定义
- 0表示无限制（读取全部消息）

### 4. 日志级别
- **常驻日志**：无论开发/生产环境都会输出
- **详细内容**：包含消息表格和API格式列表
- **性能影响**：极小，仅在发送消息时执行一次

## 验证方法

### 验证1：检查设置是否生效
```
设置的限制: 500条  ← 确认这里显示的是你设置的值
总消息数: XXX条    ← 确认消息总数
将返回: XXX条      ← 确认实际读取的消息数
```

### 验证2：检查消息是否完整
- 查看表格中的消息序号，确认从第1条开始
- 查看最后一条消息是否是刚发送的
- 确认消息数量与统计信息一致

### 验证3：检查API消息格式
- 确认 `[user]` 和 `[assistant]` 角色正确
- 确认消息内容与原始消息一致
- 确认消息顺序正确（从旧到新）

## 常见问题

### Q1: 设置了500条，但只读取了100条？
**A**: 这是正常的，因为总消息数少于500条。日志会显示：
```
设置的限制: 500条
总消息数: 100条
将返回: 100条  ← 实际只有100条可读
```

### Q2: 表格显示不全？
**A**: 消息太多时表格可能被折叠，点击控制台中的箭头展开即可。

### Q3: 看不到日志？
**A**: 
1. 确认控制台已打开（F12）
2. 确认没有过滤日志级别（显示所有级别）
3. 确认在正确的页面（聊天页面）
4. 刷新页面后重新发送消息

## 性能说明

- **日志开销**：非常小，只在发送消息时输出一次
- **表格渲染**：浏览器原生支持，性能优秀
- **内存占用**：日志不会持久化，关闭控制台后自动释放

## 后续优化建议

如果需要更详细的调试信息，可以考虑：
1. 添加系统提示词的完整输出
2. 添加记忆系统的加载日志
3. 添加世界书的触发日志
4. 添加API响应的详细信息

但目前的日志已经足够回答"AI真的读了500条吗"这个问题。
