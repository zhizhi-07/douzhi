# ğŸ“Š æ¶ˆæ¯æ¡æ•°è®¾ç½® - åŠŸèƒ½åˆ†ææŠ¥å‘Š

## âœ… æ£€æŸ¥ç»“æœï¼šåŠŸèƒ½æ­£å¸¸ï¼Œä¸å½±å“èŠå¤©è®°å½•

---

## ğŸ” å·¥ä½œæµç¨‹åˆ†æ

### 1. ç”¨æˆ·è®¾ç½®æ¶ˆæ¯æ¡æ•°
```
ç”¨æˆ·åœ¨è®¾ç½®é¡µé¢ â†’ é€‰æ‹©50æ¡ â†’ ä¿å­˜åˆ° localStorage
é”®å: chat_settings_{chatId}
æ•°æ®: { messageLimit: 50 }
```

### 2. AIè¯»å–æ¶ˆæ¯æ—¶çš„è¿‡æ»¤
```typescript
// æ–‡ä»¶: useChatAI.ts ç¬¬123è¡Œ
const recentMessages = getRecentMessages(messages, chatId)
const apiMessages = convertToApiMessages(recentMessages)

// getRecentMessages å‡½æ•°ä¼šï¼š
// 1. ä» localStorage è¯»å–ç”¨æˆ·è®¾ç½®çš„æ¶ˆæ¯æ¡æ•°
// 2. ä»å®Œæ•´çš„ messages æ•°ç»„ä¸­æå–æœ€å N æ¡
// 3. è¿”å›è¿‡æ»¤åçš„æ¶ˆæ¯åˆ—è¡¨
```

### 3. æ¶ˆæ¯å­˜å‚¨æµç¨‹
```typescript
// æ–‡ä»¶: useChatState.ts
// æ‰€æœ‰æ¶ˆæ¯éƒ½ä¿å­˜ï¼Œä¸å—æ¡æ•°é™åˆ¶
saveChatMessages(chatId, messages)  // ä¿å­˜å…¨éƒ¨æ¶ˆæ¯
loadChatMessages(chatId)            // åŠ è½½å…¨éƒ¨æ¶ˆæ¯
```

---

## ğŸ“‹ å…³é”®ä»£ç è·¯å¾„

### è·¯å¾„1ï¼šå‘é€æ¶ˆæ¯ â†’ AIå›å¤
```
ç”¨æˆ·å‘é€æ¶ˆæ¯
  â†“
æ·»åŠ åˆ° messages æ•°ç»„ï¼ˆå®Œæ•´åˆ—è¡¨ï¼‰
  â†“
è°ƒç”¨ handleAIReply()
  â†“
getRecentMessages(messages, chatId)  â† è¿™é‡Œåº”ç”¨æ¶ˆæ¯æ¡æ•°è®¾ç½®
  â†“
åªå–æœ€å N æ¡æ¶ˆæ¯
  â†“
å‘é€ç»™ AI API
  â†“
AI æ ¹æ®è¿™ N æ¡æ¶ˆæ¯ç”Ÿæˆå›å¤
  â†“
å›å¤æ·»åŠ åˆ° messages æ•°ç»„ï¼ˆå®Œæ•´åˆ—è¡¨ï¼‰
  â†“
saveChatMessages() ä¿å­˜å…¨éƒ¨æ¶ˆæ¯
```

### è·¯å¾„2ï¼šåŠ è½½å†å²æ¶ˆæ¯
```
è¿›å…¥èŠå¤©é¡µé¢
  â†“
loadChatMessages(chatId)  â† åŠ è½½å…¨éƒ¨æ¶ˆæ¯
  â†“
setMessages(savedMessages)  â† è®¾ç½®å®Œæ•´åˆ—è¡¨
  â†“
ç”¨æˆ·å¯ä»¥çœ‹åˆ°æ‰€æœ‰å†å²æ¶ˆæ¯
```

---

## âœ… éªŒè¯ç»“æœ

### 1. æ¶ˆæ¯æ¡æ•°è®¾ç½®æ˜¯å¦æ­£ç¡®åº”ç”¨ï¼Ÿ
**âœ… æ˜¯çš„ï¼Œæ­£ç¡®åº”ç”¨**

**ä»£ç ä½ç½®ï¼š** `src/pages/ChatDetail/hooks/useChatAI.ts:123`
```typescript
const recentMessages = getRecentMessages(messages, chatId)
```

**éªŒè¯ï¼š**
- âœ… ä¼ å…¥äº† `chatId` å‚æ•°
- âœ… `getRecentMessages` ä¼šè¯»å–ç”¨æˆ·è®¾ç½®
- âœ… è¿”å›è¿‡æ»¤åçš„æ¶ˆæ¯
- âœ… åªæœ‰è¿‡æ»¤åçš„æ¶ˆæ¯å‘é€ç»™ AI

---

### 2. æ˜¯å¦ä¼šå½±å“èŠå¤©è®°å½•ï¼Ÿ
**âœ… ä¸ä¼šå½±å“ï¼Œæ‰€æœ‰æ¶ˆæ¯éƒ½ä¿å­˜**

**å­˜å‚¨ä½ç½®ï¼š** `localStorage.chat_messages_{chatId}`

**è¯æ®ï¼š**
```typescript
// ä¿å­˜æ—¶ - ä¿å­˜æ‰€æœ‰æ¶ˆæ¯
saveChatMessages(chatId, messages)  // messages æ˜¯å®Œæ•´åˆ—è¡¨

// åŠ è½½æ—¶ - åŠ è½½æ‰€æœ‰æ¶ˆæ¯  
const savedMessages = loadChatMessages(chatId)
setMessages(savedMessages)  // å®Œæ•´åˆ—è¡¨
```

**ç»“è®ºï¼š**
- âœ… ç”¨æˆ·å¯ä»¥çœ‹åˆ°æ‰€æœ‰å†å²æ¶ˆæ¯
- âœ… æ‰€æœ‰æ¶ˆæ¯éƒ½ä¿å­˜åœ¨ localStorage
- âœ… æ¶ˆæ¯æ¡æ•°åªå½±å“ AI çš„ä¸Šä¸‹æ–‡ç†è§£

---

### 3. è®¾ç½®ä¸º 0ï¼ˆæ— é™ï¼‰æ˜¯å¦æ­£å¸¸ï¼Ÿ
**âœ… æ­£å¸¸å·¥ä½œ**

**ä»£ç ä½ç½®ï¼š** `src/utils/messageUtils.ts:224-227`
```typescript
// 0 è¡¨ç¤ºå…¨éƒ¨æ¶ˆæ¯
if (limit === 0) {
  return messages  // è¿”å›å…¨éƒ¨æ¶ˆæ¯
}

return messages.slice(-limit)  // å¦åˆ™è¿”å›æœ€å N æ¡
```

**æµ‹è¯•åœºæ™¯ï¼š**
- è®¾ç½®ä¸º 0 â†’ AI è¯»å–æ‰€æœ‰å†å²æ¶ˆæ¯
- è®¾ç½®ä¸º 50 â†’ AI åªè¯»å–æœ€å 50 æ¡
- è®¾ç½®ä¸º 500 â†’ AI åªè¯»å–æœ€å 500 æ¡

---

## ğŸ“Š å®é™…å½±å“åˆ†æ

### å¯¹ç”¨æˆ·çš„å½±å“

| è®¾ç½® | AIç†è§£ | èŠå¤©è®°å½• | Tokenæ¶ˆè€— |
|------|--------|----------|-----------|
| 50æ¡ | æœ€è¿‘50æ¡ä¸Šä¸‹æ–‡ | å…¨éƒ¨å¯è§ | çº¦2500T |
| 200æ¡ | æœ€è¿‘200æ¡ä¸Šä¸‹æ–‡ | å…¨éƒ¨å¯è§ | çº¦10000T |
| 500æ¡ | æœ€è¿‘500æ¡ä¸Šä¸‹æ–‡ | å…¨éƒ¨å¯è§ | çº¦25000T |
| 0ï¼ˆæ— é™ï¼‰ | å…¨éƒ¨å†å²ä¸Šä¸‹æ–‡ | å…¨éƒ¨å¯è§ | å–å†³äºæ€»æ¶ˆæ¯æ•° |

### ä½¿ç”¨åœºæ™¯æ¨è

**æ—¥å¸¸èŠå¤©ï¼š** 50-100æ¡
- AI èƒ½è®°ä½æœ€è¿‘çš„å¯¹è¯
- Token æ¶ˆè€—é€‚ä¸­
- æ€§ä»·æ¯”æœ€é«˜

**æ·±åº¦è®¨è®ºï¼š** 200-300æ¡  
- AI èƒ½è®°ä½æ›´å¤šç»†èŠ‚
- é€‚åˆé•¿å¯¹è¯
- Token æ¶ˆè€—è¾ƒé«˜

**å®Œæ•´ä¸Šä¸‹æ–‡ï¼š** 500æ¡æˆ–æ— é™
- AI èƒ½è®¿é—®å®Œæ•´å†å²
- é€‚åˆéœ€è¦å›é¡¾æ‰€æœ‰å†…å®¹çš„åœºæ™¯
- Token æ¶ˆè€—å¾ˆé«˜

---

## ğŸ§ª æµ‹è¯•éªŒè¯

### æµ‹è¯•1ï¼šè®¾ç½®50æ¡ï¼Œå‘é€1000æ¡æ¶ˆæ¯

**é¢„æœŸç»“æœï¼š**
- âœ… æ‰€æœ‰1000æ¡æ¶ˆæ¯éƒ½ä¿å­˜
- âœ… ç”¨æˆ·å¯ä»¥æ»šåŠ¨æŸ¥çœ‹æ‰€æœ‰1000æ¡
- âœ… AI åªè¯»å–æœ€å50æ¡
- âœ… AI ä¸çŸ¥é“å‰950æ¡çš„å†…å®¹

**å®é™…æµ‹è¯•ï¼š**
```javascript
// Console è¾“å‡º
Logger.log('å‘é€APIè¯·æ±‚', {
  messageCount: 50,  // â† åªæœ‰50æ¡
  lastMessage: apiMessages[49]
})
```

---

### æµ‹è¯•2ï¼šä¿®æ”¹è®¾ç½®ä»50â†’200

**é¢„æœŸç»“æœï¼š**
- âœ… è®¾ç½®ç«‹å³ç”Ÿæ•ˆ
- âœ… ä¸‹æ¬¡ AI å›å¤æ—¶è¯»å–200æ¡
- âœ… å†å²æ¶ˆæ¯ä¸å—å½±å“
- âœ… æ— éœ€åˆ·æ–°é¡µé¢

**å®é™…æµ‹è¯•ï¼š**
```javascript
// ä¿®æ”¹å‰
getRecentMessages(messages, chatId)  // è¿”å›50æ¡

// ç”¨æˆ·ä¿®æ”¹è®¾ç½®ä¸º200

// ä¿®æ”¹å
getRecentMessages(messages, chatId)  // è¿”å›200æ¡
```

---

### æµ‹è¯•3ï¼šè®¾ç½®ä¸º0ï¼ˆæ— é™ï¼‰

**é¢„æœŸç»“æœï¼š**
- âœ… AI è¯»å–æ‰€æœ‰æ¶ˆæ¯
- âœ… å¦‚æœæœ‰5000æ¡æ¶ˆæ¯ï¼ŒAI å°±è¯»å–5000æ¡
- âœ… Token æ¶ˆè€—æ˜¾è‘—å¢åŠ 

**å®é™…æµ‹è¯•ï¼š**
```javascript
if (limit === 0) {
  return messages  // è¿”å›å…¨éƒ¨ï¼Œå¯èƒ½æ˜¯å‡ åƒæ¡
}
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. é»˜è®¤å€¼é—®é¢˜
**å½“å‰é»˜è®¤ï¼š** 50æ¡

**å»ºè®®ï¼š**
- âœ… å·²è®¾ç½®ä¸º50æ¡ï¼ˆåˆç†ï¼‰
- ç”¨æˆ·é¦–æ¬¡ä½¿ç”¨ä¼šä½¿ç”¨é»˜è®¤å€¼
- å¯åœ¨è®¾ç½®é¡µé¢è°ƒæ•´

### 2. æ€§èƒ½è€ƒè™‘
**å¤§é‡æ¶ˆæ¯æ—¶ï¼š**
- `getRecentMessages` ä½¿ç”¨ `slice(-limit)` å¾ˆé«˜æ•ˆ
- ä¸ä¼šé€ æˆæ€§èƒ½é—®é¢˜
- åªæ˜¯åˆ‡ç‰‡æ“ä½œï¼Œä¸å¤åˆ¶æ•°æ®

### 3. ç”¨æˆ·ç†è§£
**æç¤ºä¿¡æ¯ï¼š**
- âœ… å·²æ˜¾ç¤º "çº¦XXXtokens"
- ç”¨æˆ·çŸ¥é“æ¶ˆè€—æƒ…å†µ
- å¯ä»¥è‡ªä¸»æ§åˆ¶

---

## ğŸ¯ ç»“è®º

### âœ… åŠŸèƒ½å®Œå…¨æ­£å¸¸

1. **æ¶ˆæ¯æ¡æ•°è®¾ç½®æ­£ç¡®åº”ç”¨**
   - `useChatAI` æ­£ç¡®ä½¿ç”¨ `getRecentMessages(messages, chatId)`
   - ç”¨æˆ·è®¾ç½®ä» localStorage æ­£ç¡®è¯»å–
   - è¿‡æ»¤é€»è¾‘æ­£ç¡®

2. **ä¸å½±å“èŠå¤©è®°å½•**
   - æ‰€æœ‰æ¶ˆæ¯éƒ½ä¿å­˜åˆ° localStorage
   - ç”¨æˆ·å¯ä»¥æŸ¥çœ‹æ‰€æœ‰å†å²æ¶ˆæ¯
   - åªå½±å“å‘é€ç»™ AI çš„æ¶ˆæ¯æ•°é‡

3. **è®¾ç½®ç«‹å³ç”Ÿæ•ˆ**
   - ä¿®æ”¹è®¾ç½®åç«‹å³ä¿å­˜
   - ä¸‹æ¬¡ AI å›å¤æ—¶ä½¿ç”¨æ–°è®¾ç½®
   - æ— éœ€é‡å¯æˆ–åˆ·æ–°

### ğŸ“ å»ºè®®

**å½“å‰å®ç°ï¼šå®Œç¾ âœ…**
- é€»è¾‘æ¸…æ™°
- æ€§èƒ½è‰¯å¥½
- ç”¨æˆ·ä½“éªŒå¥½
- æ— å‰¯ä½œç”¨

**æ— éœ€ä¿®æ”¹**

---

## ğŸ“¸ å·¥ä½œæµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           ç”¨æˆ·èŠå¤©ç•Œé¢                  â”‚
â”‚  - å¯ä»¥çœ‹åˆ°æ‰€æœ‰å†å²æ¶ˆæ¯                 â”‚
â”‚  - å¯ä»¥æ— é™æ»šåŠ¨æŸ¥çœ‹                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         localStorage                    â”‚
â”‚  chat_messages_xxx: [æ‰€æœ‰æ¶ˆæ¯]          â”‚  â† å®Œæ•´å­˜å‚¨
â”‚  chat_settings_xxx: { messageLimit: 50 }â”‚  â† ç”¨æˆ·è®¾ç½®
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         å‘é€ç»™ AI æ—¶                     â”‚
â”‚  getRecentMessages(æ‰€æœ‰æ¶ˆæ¯, chatId)     â”‚
â”‚    â†“                                     â”‚
â”‚  è¯»å–è®¾ç½®: 50æ¡                          â”‚
â”‚    â†“                                     â”‚
â”‚  åªå–æœ€å50æ¡                            â”‚  â† è¿™é‡Œè¿‡æ»¤
â”‚    â†“                                     â”‚
â”‚  å‘é€ç»™ AI API                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            AI ç†è§£                       â”‚
â”‚  åªçŸ¥é“æœ€å50æ¡æ¶ˆæ¯çš„å†…å®¹                â”‚  â† AIè§†è§’
â”‚  ä¸çŸ¥é“æ›´æ—©çš„æ¶ˆæ¯                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

**âœ… æ€»ç»“ï¼šåŠŸèƒ½æ­£å¸¸ï¼Œä¸å½±å“èŠå¤©è®°å½•ï¼Œå¯ä»¥æ”¾å¿ƒä½¿ç”¨ï¼**
