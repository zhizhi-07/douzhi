# 🔄 记忆总结改造为时间线事件记录（v2 - AI智能分析版）

## 📋 改造说明

### 原设计问题
- **Memory（记忆）** - ✅ 正确：记录静态事实（"张三有娃娃"）
- **Memory Summary（记忆总结）** - ❌ 错误：只是简单总结内容

### v1版本问题（已废弃）
❌ 机械按30分钟分组
❌ 每组只看10条消息
❌ AI无法理解完整事件（如果互怼50条消息，只看到10条）
❌ 生成的描述太水，没有细节

### v2新设计（当前版本）
- **Memory（记忆）** - 保持不变，继续记录静态事实
- **Memory Summary → Timeline（时间线）** - ✅ 让AI自己分析和分段事件

---

## ✨ 新功能：时间线事件记录

### 功能说明
时间线记录你们互动过程中发生的事件，包括：
- 普通聊天对话
- 视频通话内容
- 线下模式剧情
- 朋友圈互动（未来扩展）

### 时间线格式
```
[12/31 14:30-15:00] 视频通话讨论了周末去三亚旅行的计划
[12/31 18:20-18:35] 在朋友圈对骂，张三说了狠话导致李四生气
[01/05 20:15-20:45] 线下剧情中在咖啡厅发生争吵，张三哭了
```

---

## 🔧 技术实现

### 修改的文件

#### 1. `src/utils/memorySystem.ts`
添加了两个新方法：

**`generateTimelineFromMessages()`** - 生成时间线
- 按时间分组消息（每30分钟一个时间段）
- 智能识别消息类型（视频通话、线下模式）
- 调用AI为每个时间段生成简洁的事件描述（20字以内）
- 优化Token消耗：每个时间段只取前10条消息，每条最多150字

**`groupMessagesByTime()`** - 按时间分组
- 将消息按30分钟间隔分组
- 如果两条消息相隔超过30分钟，则分到不同组

#### 2. `src/hooks/useMemory.ts`
添加了 `generateTimeline()` 方法供React组件调用

#### 3. `src/pages/MemorySummary.tsx`
完全改造UI和逻辑：
- 页面标题改为"时间线"
- 使用新的 `generateTimeline()` 方法
- localStorage存储键改为 `memory_timeline_${id}`
- 显示格式改为等宽字体（font-mono）
- 提示文字更新

---

## 💰 Token优化策略（v2版本）

### 核心思路
✅ **让AI自己分析和分段**，不要人为限制
✅ **智能分批处理**，避免超过token限制

### 实现方案

#### 1. 小数据量（≤100条消息）
- 一次性把所有消息发给AI
- AI自己决定哪些消息属于同一个事件
- 生成包含完整细节的事件描述

#### 2. 大数据量（>100条消息）
- 自动分批处理，每批100条消息
- 每批独立分析，生成事件列表
- 最后合并所有批次的结果
- 批次之间间隔1秒，避免请求过快

#### 3. 提示词优化
- 明确要求AI识别完整事件
- 强调"如果互怼50条消息，这就是一个完整事件"
- 要求30-50字的详细描述，不要"进行了对话"这种废话
- 使用JSON格式输出，便于解析

---

## 📊 使用示例

### 生成时间线
```typescript
// 在聊天设置中点击"时间线"
→ 点击"生成时间线"按钮
→ AI分析所有消息记录
→ 按时间段生成事件描述
→ 保存到localStorage
```

### 时间线输出示例

#### v1版本输出（太水）❌
```
【时间线更新 - 2025/1/10 14:03:21】

[01/09 14:30-15:00] 用户讨论关朋友圈问变化
[01/09 15:00-15:30] 继续讨论功能
```

#### v2版本输出（详细）✅
```
【时间线更新 - 2025/1/10 14:03:21】

[01/09 14:30-15:23] 用户因同事针对心情不好，张三安慰并提议带用户出去玩散心，最终约定周末去海边
[01/09 18:20-19:15] 在朋友圈因为一条评论引发争吵，张三说了"你根本不理解我"导致用户哭了，后来张三道歉
[01/09 20:15-21:30] 线下剧情中在咖啡厅相遇，两人和好并确认了彼此的感情，张三表白成功
[01/10 10:00-11:20] 视频通话讨论未来计划，决定一起去三亚旅行，张三答应会照顾好用户
```

---

## 🎯 提示词设计（v2版本）

### 核心策略
让AI自己识别事件边界，而不是人为划分

### 关键要求

#### 1. 事件识别
- 找出所有重要事件，不要遗漏
- 重要对话、情绪变化
- 视频通话、线下剧情、朋友圈互动
- 争吵、表白、和好等关键时刻

#### 2. 事件分段（AI自己决定）
- **强调**："如果用户和AI互怼了50条消息，这就是一个完整事件"
- 不要机械地按时间分段
- 一个事件可以持续几分钟到几小时
- AI自己判断哪些消息属于同一个事件

#### 3. 事件描述（30-50字）
- 必须包含具体内容和细节
- 说明发生了什么、谁说了什么、结果如何
- **禁止**："进行了对话"、"讨论了问题"这种废话
- **要求**：具体的情节、对话、情绪、结果

#### 4. JSON格式输出
```json
[
  {
    "startTime": "MM/DD HH:mm",
    "endTime": "MM/DD HH:mm",
    "description": "事件详细描述（30-50字）"
  }
]
```

---

## 📝 存储结构

### localStorage键
- `memory_timeline_${characterId}` - 时间线记录（新增）
- `memories_${characterId}` - 记忆数据（保持不变）
- `memory_summary_${characterId}` - 旧的记忆总结（废弃）

### 数据格式
时间线采用纯文本格式，累积保存：
```
【时间线更新 - 2025/1/10 14:03】
[日期 时间-时间] 事件描述
...

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

【时间线更新 - 2025/1/11 10:20】
[日期 时间-时间] 事件描述
...
```

---

## 🚀 后续优化方向

### 1. 支持朋友圈互动事件
从 `aiInteractionMemory` 读取朋友圈互动记录，加入时间线

### 2. 智能合并相似事件
如果短时间内多次讨论同一话题，合并为一条

### 3. 事件重要度标记
标记重要事件（争吵、表白、分手等）

### 4. 导出功能
支持导出为PDF或Markdown格式

### 5. 可视化时间轴
用图形化方式展示事件时间线

---

## ✅ 测试清单

- [x] 普通聊天消息能正确生成时间线
- [ ] 视频通话记录能正确识别和总结
- [ ] 线下模式消息能正确识别和总结
- [ ] 多个时间段能正确分组
- [ ] Token消耗在合理范围内
- [ ] 时间线能累积保存
- [ ] UI显示正常

---

## 🐛 已知问题与改进

### v1版本问题（已修复）
- ❌ 机械按时间分组 → ✅ AI自己分析事件
- ❌ 只看部分消息 → ✅ 看完整消息流
- ❌ 描述太水 → ✅ 30-50字详细描述

### 当前v2版本问题
1. **消息很多时较慢** - 如果有500条消息，需要分5批处理（约5-10秒）
2. **副API必须配置** - 否则会失败（可以后续改为自动降级到主API）
3. **批次边界问题** - 分批处理时，跨批次的事件可能被拆分（概率较低）

### 可能的优化方向
- 添加进度条显示处理进度
- 批次处理时检测跨批次事件并合并
- 支持主API降级
- 缓存生成结果，避免重复生成

---

**完成时间**: 2025-01-10  
**版本**: v2 - AI智能分析版  
**状态**: ✅ 已完成核心功能  
**下一步**: 实际测试并优化提示词
